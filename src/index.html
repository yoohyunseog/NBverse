<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCTV ê°ì‹œ ì‹œìŠ¤í…œ</title>
    <!-- HLS.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- OpenCV.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
    <!-- BIT ê³„ì‚° ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="https://xn--9l4b4xi9r.com/_8%EB%B9%84%ED%8A%B8/js/bitCalculation.js"></script>
    <!-- Masonry.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #fff;
      margin: 0;
            padding: 0;
      display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: #252525;
            border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .sidebar-header h2 {
      margin: 0;
            color: #4CAF50;
            font-size: 1.3em;
        }

        .sidebar-analysis {
            padding: 15px 0;
            overflow-y: auto;
            flex: 1;
        }

        .sidebar-analysis-item {
            padding: 15px;
            margin: 10px;
            background: #2a2a2a;
            border-radius: 8px;
            border-left: 3px solid #4CAF50;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .sidebar-analysis-item:hover {
            background: #333;
            transform: translateX(3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .sidebar-analysis-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .sidebar-analysis-item-title {
            font-weight: bold;
            color: #4CAF50;
            font-size: 14px;
        }

        .sidebar-analysis-item-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        .sidebar-analysis-item-status.error {
            background: #f44336;
            animation: pulse-error 1s infinite;
        }

        .sidebar-analysis-item-content {
            font-size: 11px;
            color: #ccc;
            line-height: 1.6;
        }

        .sidebar-analysis-item-content .info-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
        }

        .sidebar-analysis-item-content .info-label {
            color: #888;
        }

        .sidebar-analysis-item-content .info-value {
            color: #4CAF50;
            font-weight: bold;
            font-family: monospace;
        }

        .sidebar-analysis-item-content .bit-value {
            color: #2196F3;
            font-size: 12px;
        }

        .camera-list-item {
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .camera-list-item::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: #4CAF50;
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .camera-list-item:hover {
            background: #333;
            transform: translateX(3px);
        }

        .camera-list-item:hover::after {
            transform: scaleY(1);
        }

        .camera-list-item.active {
            background: #2a2a2a;
            animation: listItemActive 0.3s ease;
        }

        .camera-list-item.active::after {
            transform: scaleY(1);
        }

        @keyframes listItemActive {
            0% {
                transform: translateX(-5px);
                opacity: 0.8;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .camera-list-item-name {
            flex: 1;
            font-size: 14px;
        }

        .camera-list-item-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
        }

        .camera-list-item-status.error {
            background: #f44336;
        }

        .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 20px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            font-size: 1.8em;
            margin: 0 0 5px 0;
            color: #4CAF50;
        }

        .header p {
            margin: 0;
            color: #888;
            font-size: 14px;
        }

        .controls {
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            padding: 15px 20px;
            background: #1f1f1f;
            border-bottom: 1px solid #333;
            flex-wrap: wrap;
        }

        .timer-controls {
            display: flex;
            justify-content: flex-start;
            gap: 20px;
            padding: 15px 20px;
            background: #1f1f1f;
            border-bottom: 1px solid #333;
            flex-wrap: wrap;
            align-items: center;
        }

        .timer-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timer-input-group label {
            color: #ccc;
            font-size: 14px;
            white-space: nowrap;
        }

        .timer-input-group input {
            width: 120px;
            padding: 8px 12px;
            background: #333;
            border: 1px solid #555;
            border-radius: 5px;
            color: #fff;
            font-size: 14px;
            font-family: inherit;
        }

        .timer-input-group input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }

        .timer-progress-container {
            width: 150px;
            height: 10px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .timer-progress-bar {
            height: 100%;
            width: 0%;
            border-radius: 4px;
            transition: width 0.05s linear;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
            position: relative;
        }

        .timer-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .btn {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-danger {
            background: #f44336;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-active {
            background: #2196F3 !important;
            animation: pulse-active 2s infinite;
        }

        .btn-active:hover {
            background: #1976D2 !important;
        }

        @keyframes pulse-active {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .camera-grid {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            transition: all 0.5s ease;
        }

        .camera-grid::after {
            content: '';
            display: block;
            clear: both;
        }

        .camera-grid.sorting {
            pointer-events: none;
        }

        .camera-card.sorting {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .camera-card.sorting-complete {
            animation: sortComplete 0.5s ease;
        }

        @keyframes sortComplete {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 6px 12px rgba(76, 175, 80, 0.5);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            }
        }

        /* Masonry ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .camera-grid .camera-card {
            width: calc(50% - 10px);
            margin-bottom: 20px;
            opacity: 1 !important;
            visibility: visible !important;
            transition: transform 1.2s ease, opacity 0s, visibility 0s;
        }

        .camera-grid .camera-card.masonry-item {
            transition: transform 1.2s ease, opacity 0s, visibility 0s;
        }

        /* Masonryê°€ ì ìš©ëœ ì¹´ë“œëŠ” ì ˆëŒ€ ìœ„ì¹˜ ì‚¬ìš© */
        .camera-grid .camera-card.masonry-item-positioned {
            position: absolute;
            transition: transform 1.2s ease, opacity 0s, visibility 0s;
        }

        .camera-grid .camera-card.masonry-dummy {
            width: 0 !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            position: absolute !important;
            pointer-events: none !important;
            overflow: hidden !important;
        }

        .camera-card {
            background: #2a2a2a;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: transform 1.2s ease, box-shadow 0.3s ease, opacity 0s, visibility 0s;
            display: flex;
            flex-direction: column;
            height: 100%;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            animation: cardFadeIn 0.6s ease forwards;
        }

        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .camera-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.6);
        }

        .camera-card.sorting {
            animation: cardShuffle 0.5s ease;
        }

        @keyframes cardShuffle {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.98);
            }
        }

        .camera-header {
            background: #333;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .camera-title {
            font-size: 16px;
            font-weight: bold;
            color: #4CAF50;
        }

        .camera-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite, glow 2s infinite;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }

        .status-dot.error {
            background: #f44336;
            animation: pulse-error 1s infinite, glow-error 1s infinite;
            box-shadow: 0 0 5px rgba(244, 67, 54, 0.5);
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
            }
            50% {
                box-shadow: 0 0 10px rgba(76, 175, 80, 0.8);
            }
        }

        @keyframes pulse-error {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.6;
                transform: scale(1.2);
            }
        }

        @keyframes glow-error {
            0%, 100% {
                box-shadow: 0 0 5px rgba(244, 67, 54, 0.5);
            }
            50% {
                box-shadow: 0 0 15px rgba(244, 67, 54, 1);
            }
        }

        .camera-video {
            width: 100%;
            height: 100%;
            min-height: 240px;
            background: #000;
            object-fit: contain;
            display: block;
            flex-shrink: 0;
            flex: 1;
            position: relative;
        }

        .camera-video video,
        .camera-video iframe,
        .camera-video img {
            width: auto;
            height: 100%;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .camera-overlay canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .camera-analysis {
            padding: 10px 15px;
            background: #1a1a1a;
            border-top: 1px solid #333;
            min-height: 60px;
            max-height: 120px;
            overflow-y: auto;
        }

        .camera-analysis-title {
            font-size: 12px;
            color: #4CAF50;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .camera-analysis-text {
            font-size: 11px;
            color: #ccc;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .camera-analysis-text .status-item {
            margin: 2px 0;
            padding: 2px 0;
        }

        .camera-analysis-text .motion-detected {
            color: #ff9800;
        }

        .camera-analysis-text .object-tracked {
            color: #2196F3;
        }

        .camera-bit-info {
            padding: 10px 15px;
            background: #1a1a1a;
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
            font-size: 14px;
            color: #ccc;
        }

        .camera-bit-info-title {
            color: #4CAF50;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .camera-bit-info-content {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .camera-bit-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .camera-bit-info-label {
            color: #888;
            font-size: 14px;
        }

        .camera-bit-info-value {
            color: #4CAF50;
            font-weight: bold;
            font-size: 16px;
            font-family: monospace;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .camera-bit-info-value.updating {
            animation: numberUpdate 0.5s ease;
        }

        @keyframes numberUpdate {
            0%, 100% {
                transform: scale(1);
                color: #4CAF50;
            }
            50% {
                transform: scale(1.1);
                color: #66BB6A;
            }
        }

        .camera-bit-array {
            font-family: monospace;
            font-size: 12px;
            color: #aaa;
            max-height: 80px;
            overflow-y: auto;
            margin-top: 8px;
            padding: 8px;
            background: #0a0a0a;
            border-radius: 3px;
            line-height: 1.4;
        }

        .camera-controls {
            padding: 10px 15px;
            background: #333;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-shrink: 0;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            background: #555;
        }

        .btn-small:hover {
            background: #666;
        }

        .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
            top: 0;
      width: 100%;
      height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #4CAF50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }

        .form-group input,
        .form-group textarea {
      width: 100%;
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            border-radius: 5px;
            color: #fff;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .fullscreen {
      position: fixed;
      top: 0;
      left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 999;
            background: #000;
            display: none;
        }

        .fullscreen.active {
      display: flex;
            justify-content: center;
      align-items: center;
        }

        .fullscreen video {
            max-width: 100%;
            max-height: 100%;
        }

        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
      cursor: pointer;
            font-size: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #888;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(76, 175, 80, 0.3);
            border-top-color: #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
  </style>
</head>
<body>
    <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>ğŸ“Š ë¶„ì„ ê²°ê³¼</h2>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
                CCTV: <span id="sidebarCameraCount">0</span>ëŒ€
            </div>
        </div>
        <div class="sidebar-analysis" id="sidebarAnalysis">
            <!-- ë¶„ì„ ê²°ê³¼ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
    <div class="main-content">
        <div class="header">
            <h1>ì‹¤ì‹œê°„ ì¹´ë©”ë¼ ëª¨ë‹ˆí„°ë§</h1>
            <p>ì—°ê²°ëœ ì¹´ë©”ë¼: <span id="cameraCount">0</span>ëŒ€</p>
        </div>

        <div class="controls">
            <button class="btn" onclick="openAddCameraModal()">â• ì¹´ë©”ë¼ ì¶”ê°€</button>
            <button class="btn" onclick="refreshAllCameras()">ğŸ”„ ì „ì²´ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn" onclick="sortByBitMax()">ğŸ“Š MAX ë†’ì€ ìˆœ</button>
            <button class="btn" onclick="sortByBitMin()">ğŸ“‰ MIN ë†’ì€ ìˆœ</button>
            <button class="btn" id="realtimeSortBtn10" onclick="toggleRealtimeSort(10)">âš¡ ì‹¤ì‹œê°„ MAX ì •ë ¬ (10ì´ˆ)</button>
            <button class="btn" id="realtimeSortBtn30" onclick="toggleRealtimeSort(30)">âš¡ ì‹¤ì‹œê°„ MAX ì •ë ¬ (30ì´ˆ)</button>
            <button class="btn" id="realtimeSortBtn60" onclick="toggleRealtimeSort(60)">âš¡ ì‹¤ì‹œê°„ MAX ì •ë ¬ (60ì´ˆ)</button>
            <button class="btn" onclick="reorderMasonry()">ğŸ”² Masonry ì •ë ¬</button>
            <button class="btn btn-danger" onclick="clearAllCameras()">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
        </div>

        <div class="timer-controls">
            <div class="timer-input-group">
                <label for="repeatSeconds">ë°˜ë³µ ì´ˆ (Repeat Seconds):</label>
                <input type="number" id="repeatSeconds" min="1" value="2" placeholder="ì´ˆ ë‹¨ìœ„">
                <div class="timer-progress-container">
                    <div class="timer-progress-bar" id="repeatSecondsProgress" style="background: linear-gradient(90deg, #4CAF50, #45a049);"></div>
                </div>
            </div>
            <div class="timer-input-group">
                <label for="masonryReorderTimer">Masonry ì¬ì •ë ¬ ë°˜ë³µ íƒ€ì´ë¨¸ (Masonry Reorder Timer):</label>
                <input type="number" id="masonryReorderTimer" min="1" value="5" placeholder="ì´ˆ ë‹¨ìœ„">
                <div class="timer-progress-container">
                    <div class="timer-progress-bar" id="masonryReorderProgress" style="background: linear-gradient(90deg, #2196F3, #1976D2);"></div>
                </div>
            </div>
            <div class="timer-input-group">
                <label for="boundingBoxResetTimer">ì˜ìƒ ê°ì²´ ë°•ìŠ¤ ì´ˆê¸°í™” íƒ€ì´ë¨¸ (Bounding Box Reset Timer):</label>
                <input type="number" id="boundingBoxResetTimer" min="1" value="10" placeholder="ì´ˆ ë‹¨ìœ„">
                <div class="timer-progress-container">
                    <div class="timer-progress-bar" id="boundingBoxResetProgress" style="background: linear-gradient(90deg, #FF9800, #F57C00);"></div>
                </div>
            </div>
            <div class="timer-input-group">
                <button class="btn" id="allTimersToggleBtn" onclick="toggleAllTimers()">íƒ€ì´ë¨¸ ì‹œì‘</button>
            </div>
        </div>

        <div class="camera-grid" id="cameraGrid">
            <!-- ì¹´ë©”ë¼ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
    </div>
          
    <!-- ì¹´ë©”ë¼ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="cameraModal">
        <div class="modal-content">
            <h2 id="modalTitle">ì¹´ë©”ë¼ ì¶”ê°€</h2>
            <div class="form-group">
                <label>ì¹´ë©”ë¼ ì´ë¦„</label>
                <input type="text" id="cameraName" placeholder="ì˜ˆ: í˜„ê´€ ì¹´ë©”ë¼">
            </div>
            <div class="form-group">
                <label>ìŠ¤íŠ¸ë¦¼ URL ë˜ëŠ” ì›¹ì‚¬ì´íŠ¸ ì£¼ì†Œ</label>
                <input type="text" id="cameraUrl" placeholder="http://ip:port/video ë˜ëŠ” https://www.utic.go.kr/map/map.do">
                <small style="color: #888; font-size: 12px; margin-top: 5px; display: block;">
                    ì§€ì› í˜•ì‹: HTTP/MJPEG, HLS (.m3u8), ë¹„ë””ì˜¤ íŒŒì¼, ê³µê³µ CCTV ì›¹ì‚¬ì´íŠ¸ (iframe)
                </small>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn" onclick="saveCamera()">ì €ì¥</button>
            </div>
            </div>
          </div>
          
    <!-- ì—¬ëŸ¬ URL ê°€ì ¸ì˜¤ê¸° ëª¨ë‹¬ -->
    <div class="modal" id="bulkImportModal">
        <div class="modal-content" style="max-width: 700px;">
            <h2>ì—¬ëŸ¬ URL í•œ ë²ˆì— ì¶”ê°€</h2>
            <div class="form-group">
                <label>URL ëª©ë¡ (í•œ ì¤„ì— í•˜ë‚˜ì”©)</label>
                <textarea id="bulkUrls" rows="15" style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; border-radius: 5px; color: #fff; font-family: monospace; font-size: 12px;" placeholder="https://its.gumi.go.kr:9443/live/video59.stream/chunklist_w78320174.m3u8&#10;https://its.gumi.go.kr:9443/live/video27.stream/chunklist_w1544791522.m3u8&#10;..."></textarea>
                <small style="color: #888; font-size: 12px; margin-top: 5px; display: block;">
                    â€¢ í•œ ì¤„ì— í•˜ë‚˜ì”© URLì„ ì…ë ¥í•˜ì„¸ìš”<br>
                    â€¢ JSON ë°°ì—´ í˜•ì‹ë„ ì§€ì›í•©ë‹ˆë‹¤: ["url1", "url2", ...]<br>
                    â€¢ ì¹´ë©”ë¼ ì´ë¦„ì€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ (ë˜ëŠ” URLì—ì„œ ì¶”ì¶œ)
                </small>
            </div>
            <div class="form-group">
                <label>ì´ë¦„ ì ‘ë‘ì‚¬ (ì„ íƒì‚¬í•­)</label>
                <input type="text" id="bulkNamePrefix" placeholder="ì˜ˆ: N/B CCTV" style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; border-radius: 5px; color: #fff;">
                <small style="color: #888; font-size: 12px; margin-top: 5px; display: block;">
                    ê° ì¹´ë©”ë¼ ì´ë¦„ ì•ì— ë¶™ì¼ ì ‘ë‘ì‚¬ (ì˜ˆ: "N/B CCTV 1", "N/B CCTV 2")
                </small>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="closeBulkImportModal()">ì·¨ì†Œ</button>
                <button class="btn" onclick="importBulkUrls()">ì¶”ê°€í•˜ê¸°</button>
            </div>
            <div id="bulkResult" style="margin-top: 20px; padding: 10px; background: #333; border-radius: 5px; display: none;">
                <div style="color: #4CAF50; font-weight: bold; margin-bottom: 10px;">ì¶”ê°€ ê²°ê³¼</div>
                <div id="bulkResultText" style="color: #ccc; font-size: 12px;"></div>
            </div>
        </div>
    </div>

    <!-- XML ê°€ì ¸ì˜¤ê¸° ëª¨ë‹¬ -->
    <div class="modal" id="xmlModal">
        <div class="modal-content" style="max-width: 700px;">
            <h2>XML CCTV ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</h2>
            <div class="form-group">
                <label>ë°©ì‹ ì„ íƒ</label>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="btn" onclick="switchXmlMode('api')" id="xmlModeApi">API URL</button>
                    <button class="btn" onclick="switchXmlMode('text')" id="xmlModeText">XML í…ìŠ¤íŠ¸</button>
                </div>
            </div>
            <div class="form-group" id="xmlApiGroup">
                <label>API URL</label>
                <input type="text" id="xmlApiUrl" placeholder="https://api.example.com/cctv/list">
                <small style="color: #888; font-size: 12px; margin-top: 5px; display: block;">
                    CCTV API ì—”ë“œí¬ì¸íŠ¸ URLì„ ì…ë ¥í•˜ì„¸ìš”
                </small>
            </div>
            <div class="form-group" id="xmlTextGroup" style="display: none;">
                <label>XML ë°ì´í„°</label>
                <textarea id="xmlText" rows="15" style="width: 100%; padding: 10px; background: #333; border: 1px solid #555; border-radius: 5px; color: #fff; font-family: monospace; font-size: 12px;" placeholder="XML ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="closeXmlModal()">ì·¨ì†Œ</button>
                <button class="btn" onclick="importXml()">ê°€ì ¸ì˜¤ê¸°</button>
            </div>
            <div id="xmlResult" style="margin-top: 20px; padding: 10px; background: #333; border-radius: 5px; display: none;">
                <div style="color: #4CAF50; font-weight: bold; margin-bottom: 10px;">íŒŒì‹± ê²°ê³¼</div>
                <div id="xmlResultText" style="color: #ccc; font-size: 12px;"></div>
            </div>
        </div>
    </div>

    <!-- ì „ì²´í™”ë©´ ëª¨ë‹¬ -->
    <div class="fullscreen" id="fullscreen">
        <button class="fullscreen-close" onclick="closeFullscreen()">âœ• ë‹«ê¸°</button>
        <video id="fullscreenVideo" controls autoplay></video>
          </div>

  <script>
        let cameras = [];
        let editingIndex = -1;
        let masonryInstance = null; // Masonry ì¸ìŠ¤í„´ìŠ¤

        // ê¸°ë³¸ ì¹´ë©”ë¼ ì¶”ê°€ (N/B CCTV)
        function initDefaultCameras() {
            const urls = [
                "https://its.gumi.go.kr:9443/live/video59.stream/chunklist_w78320174.m3u8",
                "https://its.gumi.go.kr:9443/live/video27.stream/chunklist_w1544791522.m3u8",
                "https://its.gumi.go.kr:9443/live/video29.stream/chunklist_w61936289.m3u8",
                "https://its.gumi.go.kr:9443/live/video28.stream/chunklist_w1531508167.m3u8",
                "https://its.gumi.go.kr:9443/live/video50.stream/chunklist_w194564642.m3u8",
                "https://its.gumi.go.kr:9443/live/video9.stream/chunklist_w1954125290.m3u8",
                "https://its.gumi.go.kr:9443/live/video92.stream/chunklist_w2046121575.m3u8",
                "https://its.gumi.go.kr:9443/live/video47.stream/chunklist_w1457521598.m3u8",
                "https://its.gumi.go.kr:9443/live/video24.stream/chunklist_w1322625794.m3u8",
                "https://its.gumi.go.kr:9443/live/video47.stream/chunklist_w26989886.m3u8",
                "https://its.gumi.go.kr:9443/live/video55.stream/chunklist_w4108831.m3u8",
                "https://its.gumi.go.kr:9443/live/video13.stream/chunklist_w331440974.m3u8",
                "https://its.gumi.go.kr:9443/live/video40.stream/chunklist_w408885452.m3u8"
            ];

            cameras = urls.map((url, index) => {
                // URLì—ì„œ ì¹´ë©”ë¼ ë²ˆí˜¸ ì¶”ì¶œ
                const videoMatch = url.match(/video(\d+)\.stream/);
                const cameraNum = videoMatch ? videoMatch[1] : (index + 1);
                return {
                    name: `N/B CCTV ${cameraNum}`,
                    url: url
                };
            });
            
            renderCameras();
            renderCameraList();
        }

        // ì¹´ë©”ë¼ ë¡œë“œ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš© ì•ˆ í•¨)
        function loadCameras() {
            initDefaultCameras();
        }

        // ì¹´ë©”ë¼ ì €ì¥ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš© ì•ˆ í•¨)
        function saveCameras() {
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
        }

        // BIT MAX ê°’ ê¸°ì¤€ ìˆœìœ„ë³„ ìƒ‰ìƒ ê³„ì‚° (ë¹¨ê°„ìƒ‰ ~ í°ìƒ‰)
        function getBitRankColor(bitMaxValue, rank, totalCount) {
            if (bitMaxValue === 'ê³„ì‚° ì¤‘...' || bitMaxValue === 'ì˜¤ë¥˜' || isNaN(parseFloat(bitMaxValue))) {
                return '#888'; // ê¸°ë³¸ íšŒìƒ‰
            }
            
            if (totalCount <= 1) {
                return '#ff0000'; // ë¹¨ê°„ìƒ‰ (1ìœ„)
            }
            
            // ìˆœìœ„ë¥¼ 0~1 ì‚¬ì´ì˜ ë¹„ìœ¨ë¡œ ë³€í™˜ (1ìœ„ê°€ 0, ë§ˆì§€ë§‰ì´ 1)
            const ratio = (rank - 1) / (totalCount - 1);
            
            // ë¹¨ê°„ìƒ‰(#ff0000)ì—ì„œ í°ìƒ‰(#ffffff)ìœ¼ë¡œ ê·¸ë¼ë°ì´ì…˜
            // 1ìœ„(ratio=0): ë¹¨ê°„ìƒ‰ rgb(255, 0, 0)
            // ë§ˆì§€ë§‰(ratio=1): í°ìƒ‰ rgb(255, 255, 255)
            const r = 255; // ë¹¨ê°•ì€ í•­ìƒ ìµœëŒ€
            const g = Math.floor(255 * ratio); // 0ì—ì„œ 255ë¡œ ì¦ê°€
            const b = Math.floor(255 * ratio); // 0ì—ì„œ 255ë¡œ ì¦ê°€
            
            return `rgb(${r}, ${g}, ${b})`;
        }

        // ì‚¬ì´ë“œë°” ë¶„ì„ ê²°ê³¼ ë Œë”ë§
        function renderCameraList() {
            const sidebarContainer = document.getElementById('sidebarAnalysis');
            const sidebarCount = document.getElementById('sidebarCameraCount');
            
            if (sidebarCount) {
                sidebarCount.textContent = cameras.length;
            }
            
            if (cameras.length === 0) {
                if (sidebarContainer) {
                    sidebarContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #888; font-size: 12px;">ì¹´ë©”ë¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                }
                return;
            }

            if (!sidebarContainer) return;

            // ëª¨ë“  ì¹´ë©”ë¼ì˜ BIT MAX ê°’ì„ ìˆ˜ì§‘í•˜ì—¬ ìˆœìœ„ ê³„ì‚°
            const bitMaxValues = cameras.map((camera, index) => {
                const bitMaxElement = document.getElementById(`bit-max-${index}`);
                let bitMax = 'ê³„ì‚° ì¤‘...';
                if (bitMaxElement && bitMaxElement.textContent !== 'ê³„ì‚° ì¤‘...' && bitMaxElement.textContent !== 'ì˜¤ë¥˜') {
                    bitMax = bitMaxElement.textContent;
                }
                return { index, value: bitMax, numValue: parseFloat(bitMax) || 0 };
            });

            // BIT MAX ê°’ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ìˆœìœ„ ê³„ì‚°
            const sorted = [...bitMaxValues].sort((a, b) => b.numValue - a.numValue);
            const rankMap = new Map();
            sorted.forEach((item, rank) => {
                rankMap.set(item.index, rank + 1);
            });

            sidebarContainer.innerHTML = cameras.map((camera, index) => {
                const data = analysisData[index] || {};
                const bitMaxElement = document.getElementById(`bit-max-${index}`);
                const bitMinElement = document.getElementById(`bit-min-${index}`);
                const bitAvg10Element = document.getElementById(`bit-avg-10-${index}`);
                const bitAvg30Element = document.getElementById(`bit-avg-30-${index}`);
                const bitAvg60Element = document.getElementById(`bit-avg-60-${index}`);
                
                let bitMax = 'ê³„ì‚° ì¤‘...';
                let bitMin = 'ê³„ì‚° ì¤‘...';
                let bitAvg10 = '-';
                let bitAvg30 = '-';
                let bitAvg60 = '-';
                
                if (bitMaxElement && bitMaxElement.textContent !== 'ê³„ì‚° ì¤‘...' && bitMaxElement.textContent !== 'ì˜¤ë¥˜') {
                    bitMax = bitMaxElement.textContent;
                }
                if (bitMinElement && bitMinElement.textContent !== 'ê³„ì‚° ì¤‘...' && bitMinElement.textContent !== 'ì˜¤ë¥˜') {
                    bitMin = bitMinElement.textContent;
                }
                if (bitAvg10Element && bitAvg10Element.textContent !== '-' && bitAvg10Element.textContent !== 'ê³„ì‚° ì¤‘...') {
                    bitAvg10 = bitAvg10Element.textContent;
                }
                if (bitAvg30Element && bitAvg30Element.textContent !== '-' && bitAvg30Element.textContent !== 'ê³„ì‚° ì¤‘...') {
                    bitAvg30 = bitAvg30Element.textContent;
                }
                if (bitAvg60Element && bitAvg60Element.textContent !== '-' && bitAvg60Element.textContent !== 'ê³„ì‚° ì¤‘...') {
                    bitAvg60 = bitAvg60Element.textContent;
                }

                // ìˆœìœ„ë³„ ìƒ‰ìƒ ê³„ì‚°
                const rank = rankMap.get(index) || cameras.length;
                const bitMaxColor = getBitRankColor(bitMax, rank, cameras.length);

                const motionCount = data.motionCount || 0;
                const objectCount = (data.objects && data.objects.length) || 0;
                const background = data.background || {};
                const brightness = background.averageBrightness || 0;
                const stability = background.stability || 0;

                return `
                    <div class="sidebar-analysis-item" onclick="focusCamera(${index})">
                        <div class="sidebar-analysis-item-header">
                            <div class="sidebar-analysis-item-title">${camera.name || `ì¹´ë©”ë¼ ${index + 1}`}</div>
                            <div class="sidebar-analysis-item-status" id="sidebar-status-${index}"></div>
                        </div>
                        <div class="sidebar-analysis-item-content">
                            <div class="info-row">
                                <span class="info-label">BIT MAX:</span>
                                <span class="info-value bit-value" style="color: ${bitMaxColor};">${bitMax}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">BIT MIN:</span>
                                <span class="info-value bit-value">${bitMin}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">í‰ê·  (10ì´ˆ):</span>
                                <span class="info-value bit-value">${bitAvg10}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">í‰ê·  (30ì´ˆ):</span>
                                <span class="info-value bit-value">${bitAvg30}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">í‰ê·  (60ì´ˆ):</span>
                                <span class="info-value bit-value">${bitAvg60}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ì›€ì§ì„:</span>
                                <span class="info-value">${motionCount}ê°œ</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ê°ì²´:</span>
                                <span class="info-value">${objectCount}ê°œ</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ë°ê¸°:</span>
                                <span class="info-value">${brightness}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ì•ˆì •ì„±:</span>
                                <span class="info-value">${stability}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
            cameras.forEach((camera, index) => {
                const statusElement = document.getElementById(`sidebar-status-${index}`);
                const mainStatusElement = document.getElementById(`status-${index}`);
                if (statusElement && mainStatusElement) {
                    if (mainStatusElement.classList.contains('error')) {
                        statusElement.classList.add('error');
                    } else {
                        statusElement.classList.remove('error');
                    }
                }
            });

            // ì¹´ë©”ë¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
            document.getElementById('cameraCount').textContent = cameras.length;
        }

        // ì¹´ë©”ë¼ ë Œë”ë§
        function renderCameras() {
            const grid = document.getElementById('cameraGrid');
            
            if (cameras.length === 0) {
                grid.innerHTML = '<div class="empty-state"><p>ì¹´ë©”ë¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p></div>';
                renderCameraList();
                return;
            }

            // Masonry ë²„ê·¸ í•´ê²°ì„ ìœ„í•œ ì²« ë²ˆì§¸ ë”ë¯¸ ìš”ì†Œ
            const dummyElement = '<div class="camera-card masonry-dummy" style="width: 0; height: 0; margin: 0; padding: 0; border: none; opacity: 0; visibility: hidden; position: absolute; pointer-events: none;"></div>';
            
            grid.innerHTML = dummyElement + cameras.map((camera, index) => `
                <div class="camera-card" id="card-${index}" style="animation-delay: ${index * 0.05}s;">
                    <div class="camera-header">
                        <div class="camera-title">${camera.name || `ì¹´ë©”ë¼ ${index + 1}`}</div>
                        <div class="camera-status">
                            <div class="status-dot" id="status-${index}"></div>
                            <span>ì—°ê²°ë¨</span>
                        </div>
                    </div>
                    ${getVideoElement(camera.url, index)}
                    <div class="camera-analysis" id="analysis-${index}">
                        <div class="camera-analysis-title">ğŸ“Š ë¶„ì„ ê²°ê³¼</div>
                        <div class="camera-analysis-text" id="analysis-text-${index}">ë¶„ì„ ì¤‘...</div>
                    </div>
                    <div class="camera-bit-info" id="bit-info-${index}">
                        <div class="camera-bit-info-title">ğŸ”¢ BIT ê³„ì‚° ì •ë³´</div>
                        <div class="camera-bit-info-content">
                            <div class="camera-bit-info-row">
                                <span class="camera-bit-info-label">BIT MAX:</span>
                                <span class="camera-bit-info-value" id="bit-max-${index}">ê³„ì‚° ì¤‘...</span>
                            </div>
                            <div class="camera-bit-info-row">
                                <span class="camera-bit-info-label">BIT MIN:</span>
                                <span class="camera-bit-info-value" id="bit-min-${index}">ê³„ì‚° ì¤‘...</span>
                            </div>
                            <div class="camera-bit-info-row">
                                <span class="camera-bit-info-label">í‰ê·  (10ì´ˆ):</span>
                                <span class="camera-bit-info-value" id="bit-avg-10-${index}">-</span>
                            </div>
                            <div class="camera-bit-info-row">
                                <span class="camera-bit-info-label">í‰ê·  (30ì´ˆ):</span>
                                <span class="camera-bit-info-value" id="bit-avg-30-${index}">-</span>
                            </div>
                            <div class="camera-bit-info-row">
                                <span class="camera-bit-info-label">í‰ê·  (60ì´ˆ):</span>
                                <span class="camera-bit-info-value" id="bit-avg-60-${index}">-</span>
                            </div>
                            <div class="camera-bit-array" id="bit-array-${index}">ë°°ì—´ ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>
                    <div class="camera-controls">
                        <button class="btn btn-small" onclick="editCamera(${index})">âœï¸ ìˆ˜ì •</button>
                        <button class="btn btn-small" onclick="openFullscreen(${index})">ğŸ” í™•ëŒ€</button>
                        <button class="btn btn-small btn-danger" onclick="deleteCamera(${index})">ğŸ—‘ï¸ ì‚­ì œ</button>
                    </div>
                </div>
            `).join('');

            // ë¹„ë””ì˜¤ ë¡œë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            cameras.forEach((camera, index) => {
                const element = document.getElementById(`video-${index}`);
                const video = element && element.tagName === 'VIDEO' ? element : null;
                const img = element && element.tagName === 'IMG' ? element : null;
                const iframe = element && element.tagName === 'IFRAME' ? element : null;
                
                if (element) {
                    // iframeì˜ ê²½ìš° ë¡œë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬
                    if (iframe) {
                        iframe.addEventListener('load', () => {
                            const statusDot = document.getElementById(`status-${index}`);
                            const sidebarStatus = document.getElementById(`sidebar-status-${index}`);
                            if (statusDot) statusDot.classList.remove('error');
                            if (sidebarStatus) sidebarStatus.classList.remove('error');
                        });
                        iframe.addEventListener('error', () => {
                            const statusDot = document.getElementById(`status-${index}`);
                            const sidebarStatus = document.getElementById(`sidebar-status-${index}`);
                            if (statusDot) statusDot.classList.add('error');
                            if (sidebarStatus) sidebarStatus.classList.add('error');
                        });
                    } else {
                        element.addEventListener('error', () => {
                            const statusDot = document.getElementById(`status-${index}`);
                            const sidebarStatus = document.getElementById(`sidebar-status-${index}`);
                            if (statusDot) statusDot.classList.add('error');
                            if (sidebarStatus) sidebarStatus.classList.add('error');
                        });
                        
                        if (video) {
                            // HLS ìŠ¤íŠ¸ë¦¼ì¸ì§€ í™•ì¸
                            const camera = cameras[index];
                            if (camera && (camera.url.includes('.m3u8') || camera.url.includes('chunklist'))) {
                                // HLS.jsë¡œ ì¬ìƒ
                                if (typeof Hls !== 'undefined' && Hls.isSupported()) {
                                    const hls = new Hls({
                                        enableWorker: true,
                                        lowLatencyMode: true,
                                        backBufferLength: 90
                                    });
                                    hls.loadSource(camera.url);
                                    hls.attachMedia(video);
                                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                                        video.play().catch(e => {
                                            console.log('ìë™ ì¬ìƒ ì‹¤íŒ¨:', e);
                                        });
                                        const statusDot = document.getElementById(`status-${index}`);
                                        const sidebarStatus = document.getElementById(`sidebar-status-${index}`);
                                        if (statusDot) statusDot.classList.remove('error');
                                        if (sidebarStatus) sidebarStatus.classList.remove('error');
                                        // ë¶„ì„ ì‹œì‘
                                        setTimeout(() => initAnalysis(index, video), 2000);
                                    });
                                    hls.on(Hls.Events.ERROR, (event, data) => {
                                        // fatal ì˜¤ë¥˜ë§Œ ë¡œê·¸ (403 Forbidden ê°™ì€ ì¼ì‹œì  ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬)
                                        if (data.fatal) {
                                            console.error(`HLS ì¹˜ëª…ì  ì˜¤ë¥˜ (ì¹´ë©”ë¼ ${index}):`, data);
                                            const statusDot = document.getElementById(`status-${index}`);
                                            const sidebarStatus = document.getElementById(`sidebar-status-${index}`);
                                            if (statusDot) statusDot.classList.add('error');
                                            if (sidebarStatus) sidebarStatus.classList.add('error');
                                        } else if (data.details === 'fragLoadError' && data.response && data.response.code === 403) {
                                            // 403 Forbiddenì€ ì„œë²„ ì¸¡ ë¬¸ì œì´ë¯€ë¡œ ì¡°ìš©íˆ ì²˜ë¦¬
                                            // ìƒíƒœ í‘œì‹œë§Œ ì—…ë°ì´íŠ¸
                                            const statusDot = document.getElementById(`status-${index}`);
                                            if (statusDot && !statusDot.classList.contains('error')) {
                                                statusDot.classList.add('error');
                                            }
                                        }
                                    });
                                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                    // Safari ë„¤ì´í‹°ë¸Œ HLS ì§€ì›
                                    video.src = camera.url;
                                    video.addEventListener('loadedmetadata', () => {
                                        video.play().catch(e => {
                                            console.log('ìë™ ì¬ìƒ ì‹¤íŒ¨:', e);
                                        });
                                        const statusDot = document.getElementById(`status-${index}`);
                                        const sidebarStatus = document.getElementById(`sidebar-status-${index}`);
                                        if (statusDot) statusDot.classList.remove('error');
                                        if (sidebarStatus) sidebarStatus.classList.remove('error');
                                        // ë¶„ì„ ì‹œì‘
                                        setTimeout(() => initAnalysis(index, video), 2000);
                                    });
                                } else {
                                    const statusDot = document.getElementById(`status-${index}`);
                                    const listStatus = document.getElementById(`list-status-${index}`);
                                    if (statusDot) statusDot.classList.add('error');
                                    if (listStatus) listStatus.classList.add('error');
                                }
                            } else {
                                // ì¼ë°˜ ë¹„ë””ì˜¤
                                video.addEventListener('loadeddata', () => {
                                    const statusDot = document.getElementById(`status-${index}`);
                                    const listStatus = document.getElementById(`list-status-${index}`);
                                    if (statusDot) statusDot.classList.remove('error');
                                    if (listStatus) listStatus.classList.remove('error');
                                    // ë¶„ì„ ì‹œì‘
                                    setTimeout(() => initAnalysis(index, video), 1000);
                                });
                            }
                        } else if (img) {
                            img.addEventListener('load', () => {
                                const statusDot = document.getElementById(`status-${index}`);
                                const listStatus = document.getElementById(`list-status-${index}`);
                                if (statusDot) statusDot.classList.remove('error');
                                if (listStatus) listStatus.classList.remove('error');
                            });
                        }
                    }
                }
            });

            renderCameraList();
            
            // Masonry ì´ˆê¸°í™” ë˜ëŠ” ì—…ë°ì´íŠ¸
            initMasonry();
        }

        // Masonry ë ˆì´ì•„ì›ƒ ì´ˆê¸°í™”
        function initMasonry() {
            const grid = document.getElementById('cameraGrid');
            if (!grid) return;

            // Masonry.jsê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (typeof Masonry === 'undefined') {
                // Masonry.jsê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¬ì‹œë„
                setTimeout(initMasonry, 100);
                return;
            }

            // ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆìœ¼ë©´ ì œê±°
            if (masonryInstance) {
                masonryInstance.destroy();
                masonryInstance = null;
            }

            // ì»¨í…Œì´ë„ˆ ë„ˆë¹„ ê³„ì‚° (íŒ¨ë”© ì œì™¸)
            const containerWidth = grid.offsetWidth - 40; // ì¢Œìš° íŒ¨ë”© 20pxì”©
            const columnWidth = (containerWidth - 20) / 2; // 2ì—´, ê°„ê²© 20px

            // ìƒˆë¡œìš´ Masonry ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (ë”ë¯¸ ìš”ì†Œ ì œì™¸)
            masonryInstance = new Masonry(grid, {
                itemSelector: '.camera-card:not(.masonry-dummy)',
                columnWidth: columnWidth,
                percentPosition: false,
                gutter: 20,
                transitionDuration: '1.2s',
                stagger: 0,
                resize: true
            });

            // ì´ë¯¸ì§€ ë¡œë“œ í›„ ë ˆì´ì•„ì›ƒ ì¬ì¡°ì •
            const images = grid.querySelectorAll('img, video');
            let imagesLoaded = 0;
            const totalImages = images.length;

            if (totalImages === 0) {
                masonryInstance.layout();
                return;
            }

            images.forEach(img => {
                if (img.complete) {
                    imagesLoaded++;
                    if (imagesLoaded === totalImages) {
                        masonryInstance.layout();
                    }
                } else {
                    img.addEventListener('load', () => {
                        imagesLoaded++;
                        if (imagesLoaded === totalImages) {
                            masonryInstance.layout();
                        }
                    });
                    img.addEventListener('error', () => {
                        imagesLoaded++;
                        if (imagesLoaded === totalImages) {
                            masonryInstance.layout();
                        }
                    });
                }
            });
        }

        // ì¹´ë©”ë¼ í¬ì»¤ìŠ¤ (ì‚¬ì´ë“œë°”ì—ì„œ í´ë¦­ ì‹œ)
        function focusCamera(index) {
            const card = document.getElementById(`card-${index}`);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                card.style.border = '2px solid #4CAF50';
                setTimeout(() => {
                    card.style.border = '';
                }, 2000);
            }
        }

        // ì „ì²´ ë³´ê¸°
        function showAllCameras() {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.menu-item').classList.add('active');
        }

        // ì„¤ì • ë³´ê¸°
        function showSettings() {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.menu-item').classList.add('active');
            alert('ì„¤ì • ê¸°ëŠ¥ì€ ì¶”í›„ ì¶”ê°€ ì˜ˆì •ì…ë‹ˆë‹¤.');
        }

        // ë¹„ë””ì˜¤ ìš”ì†Œ ìƒì„± (URL íƒ€ì…ì— ë”°ë¼)
        function getVideoElement(url, index) {
            if (!url) {
                return '<div class="camera-video" style="display: flex; align-items: center; justify-content: center; color: #888;">URL ì—†ìŒ</div>';
            }

            // HLS ìŠ¤íŠ¸ë¦¼ ë¨¼ì € ì²´í¬ (chunklist í¬í•¨)
            if (url.includes('.m3u8') || url.includes('chunklist')) {
                return `
                    <div class="camera-video">
                        <video id="video-${index}" autoplay muted loop playsinline controls style="width: auto; height: 100%; object-fit: contain; display: block; margin: 0 auto;">
                            ë¸Œë¼ìš°ì €ê°€ HLSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        </video>
                        <div class="camera-overlay">
                            <canvas id="overlay-${index}"></canvas>
                        </div>
                    </div>
                `;
            }

            // ì›¹ì‚¬ì´íŠ¸ URL (ê³µê³µ CCTV ë“±) - iframeìœ¼ë¡œ ì„ë² ë“œ
            if (url.startsWith('http://') || url.startsWith('https://')) {
                // .m3u8, .mp4, .jpg ë“± ë¹„ë””ì˜¤/ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹Œ ê²½ìš° ì›¹ì‚¬ì´íŠ¸ë¡œ ê°„ì£¼
                const isMediaFile = url.match(/\.(m3u8|mp4|avi|mov|webm|jpg|jpeg|png|gif|mjpeg|video)(\?|$)/i);
                if (!isMediaFile && !url.includes('/video') && !url.includes('/stream') && !url.includes('/mjpeg') && !url.includes('chunklist')) {
                    return `
                        <iframe 
                            class="camera-video" 
                            id="video-${index}" 
                            src="${url}" 
                            frameborder="0" 
                            allowfullscreen
                            style="width: 100%; height: 100%; border: none;"
                            onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'height: 240px; display: flex; align-items: center; justify-content: center; color: #f44336; flex-direction: column; gap: 10px;\\'><div>ì›¹ì‚¬ì´íŠ¸ ë¡œë“œ ì‹¤íŒ¨</div><div style=\\'font-size: 12px; color: #888;\\'>X-Frame-Optionsë¡œ ì¸í•´ ì„ë² ë“œê°€ ì°¨ë‹¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div></div>';"
                        ></iframe>
                    `;
                }
            }

            // RTSPëŠ” ì§ì ‘ ì¬ìƒ ë¶ˆê°€, ì•ˆë‚´ ë©”ì‹œì§€
            if (url.startsWith('rtsp://')) {
                return `
                    <div class="camera-video" style="display: flex; align-items: center; justify-content: center; color: #f44336; flex-direction: column; gap: 10px;">
                        <div>RTSP ìŠ¤íŠ¸ë¦¼</div>
                        <div style="font-size: 12px; color: #888;">ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ì¬ìƒ ë¶ˆê°€</div>
                        <div style="font-size: 12px; color: #888;">ë³€í™˜ ì„œë²„ í•„ìš”</div>
          </div>
        `;
            }

            // MJPEG ë˜ëŠ” ì¼ë°˜ ë¹„ë””ì˜¤
            if (url.includes('.jpg') || url.includes('.jpeg') || url.includes('mjpeg') || url.includes('video')) {
                return `
                    <div class="camera-video">
                        <img id="video-${index}" src="${url}" alt="Camera ${index + 1}" style="width: auto; height: 100%; object-fit: contain; display: block; margin: 0 auto;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'height: 240px; display: flex; align-items: center; justify-content: center; color: #f44336;\\'>ì—°ê²° ì‹¤íŒ¨</div>';">
                        <div class="camera-overlay">
                            <canvas id="overlay-${index}"></canvas>
                        </div>
                    </div>
                `;
            }

            // ì¼ë°˜ ë¹„ë””ì˜¤
            return `
                <div class="camera-video">
                    <video id="video-${index}" autoplay muted loop playsinline controls style="width: auto; height: 100%; object-fit: contain; display: block; margin: 0 auto;">
                        <source src="${url}" type="video/mp4">
                        ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </video>
                    <div class="camera-overlay">
                        <canvas id="overlay-${index}"></canvas>
                    </div>
                </div>
            `;
        }

        // ëª¨ë‹¬ ì—´ê¸°
        function openAddCameraModal() {
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = 'ì¹´ë©”ë¼ ì¶”ê°€';
            document.getElementById('cameraName').value = '';
            document.getElementById('cameraUrl').value = '';
            document.getElementById('cameraModal').classList.add('active');
        }

        // ì¹´ë©”ë¼ ìˆ˜ì •
        function editCamera(index) {
            editingIndex = index;
            const camera = cameras[index];
            document.getElementById('modalTitle').textContent = 'ì¹´ë©”ë¼ ìˆ˜ì •';
            document.getElementById('cameraName').value = camera.name || '';
            document.getElementById('cameraUrl').value = camera.url || '';
            document.getElementById('cameraModal').classList.add('active');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('cameraModal').classList.remove('active');
        }

        // ì¹´ë©”ë¼ ì €ì¥
        function saveCamera() {
            const name = document.getElementById('cameraName').value.trim();
            const url = document.getElementById('cameraUrl').value.trim();

            if (!url) {
                alert('ìŠ¤íŠ¸ë¦¼ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
          }

            const camera = {
                name: name || `ì¹´ë©”ë¼ ${cameras.length + 1}`,
                url: url
            };

            if (editingIndex >= 0) {
                cameras[editingIndex] = camera;
            } else {
                cameras.push(camera);
            }

            saveCameras();
            renderCameras();
            renderCameraList();
            closeModal();
        }

        // ì¹´ë©”ë¼ ì‚­ì œ
        function deleteCamera(index) {
            if (confirm('ì´ ì¹´ë©”ë¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                cameras.splice(index, 1);
                saveCameras();
                renderCameras();
                renderCameraList();
            }
        }

        // ì „ì²´ ìƒˆë¡œê³ ì¹¨
        function refreshAllCameras() {
            renderCameras();
            renderCameraList();
        }

        // BIT MAX ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
        function sortByBitMax() {
            const grid = document.getElementById('cameraGrid');
            if (!grid) return;

            // ì •ë ¬ ì‹œì‘ í‘œì‹œ
            grid.classList.add('sorting');
            let allCards = grid.querySelectorAll('.camera-card');
            allCards.forEach(card => {
                card.classList.add('sorting');
            });

            // ê° ì¹´ë©”ë¼ì˜ BIT MAX ê°’ì„ ê°€ì ¸ì™€ì„œ ì •ë ¬
            const camerasWithBit = cameras.map((camera, index) => {
                const bitMaxElement = document.getElementById(`bit-max-${index}`);
                let bitMax = 0;
                if (bitMaxElement && bitMaxElement.textContent !== 'ê³„ì‚° ì¤‘...' && bitMaxElement.textContent !== 'ì˜¤ë¥˜') {
                    const value = parseFloat(bitMaxElement.textContent);
                    if (!isNaN(value)) {
                        bitMax = value;
                    }
                }
                return { 
                    camera, 
                    index, 
                    bitMax, 
                    cardElement: document.getElementById(`card-${index}`),
                    analysisData: analysisData[index] || {}
                };
            });

            // BIT MAX ê°’ì´ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
            camerasWithBit.sort((a, b) => b.bitMax - a.bitMax);

            // ì •ë ¬ëœ ìˆœì„œë¡œ cameras ë°°ì—´ ì¬êµ¬ì„±
            const newCameras = [];
            const newAnalysisData = {};
            
            camerasWithBit.forEach((item, newIndex) => {
                newCameras.push(item.camera);
                newAnalysisData[newIndex] = item.analysisData;
            });
            
            cameras = newCameras;
            analysisData = newAnalysisData;

            // DOM ìˆœì„œë§Œ ë³€ê²½ (ì¬ë Œë”ë§ ì—†ì´)
            // ê¹œë¹¡ì„ ë°©ì§€ë¥¼ ìœ„í•´ ëª¨ë“  ì¹´ë“œì˜ opacity ìœ ì§€ (ë”ë¯¸ ìš”ì†Œ ì œì™¸)
            allCards = grid.querySelectorAll('.camera-card:not(.masonry-dummy)');
            allCards.forEach(card => {
                card.style.opacity = '1';
                card.style.visibility = 'visible';
                card.style.transition = 'transform 1.2s ease, opacity 0.3s ease';
            });

            // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ í˜„ì¬ ìœ„ì¹˜ ì €ì¥
            const cardPositions = new Map();
            allCards.forEach(card => {
                const rect = card.getBoundingClientRect();
                cardPositions.set(card, {
                    x: rect.left,
                    y: rect.top
                });
            });

            // ì •ë ¬ëœ ìˆœì„œëŒ€ë¡œ ì¹´ë“œë¥¼ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— ë°°ì¹˜
            camerasWithBit.forEach((item, newIndex) => {
                if (item.cardElement && item.cardElement.parentNode === grid) {
                    // ì¹´ë“œì˜ opacityì™€ visibility ìœ ì§€
                    item.cardElement.style.opacity = '1';
                    item.cardElement.style.visibility = 'visible';
                    
                    // í˜„ì¬ DOMì—ì„œì˜ ìœ„ì¹˜ í™•ì¸ (ë”ë¯¸ ìš”ì†Œ ì œì™¸)
                    const children = Array.from(grid.children).filter(child => !child.classList.contains('masonry-dummy'));
                    const currentIndex = children.indexOf(item.cardElement);
                    
                    // ìƒˆ ìœ„ì¹˜ê°€ í˜„ì¬ ìœ„ì¹˜ì™€ ë‹¤ë¥¼ ë•Œë§Œ ì´ë™
                    if (currentIndex !== newIndex) {
                        const allChildren = Array.from(grid.children);
                        const dummyElement = allChildren.find(child => child.classList.contains('masonry-dummy'));
                        const realChildren = allChildren.filter(child => !child.classList.contains('masonry-dummy'));
                        
                        if (newIndex === 0) {
                            // ì²« ë²ˆì§¸ ìœ„ì¹˜: ë”ë¯¸ ìš”ì†Œ ë‹¤ìŒì— ì‚½ì…
                            if (dummyElement) {
                                if (dummyElement.nextSibling && dummyElement.nextSibling !== item.cardElement) {
                                    grid.insertBefore(item.cardElement, dummyElement.nextSibling);
                                } else {
                                    grid.insertBefore(item.cardElement, dummyElement.nextSibling);
                                }
                            } else {
                                grid.insertBefore(item.cardElement, grid.firstChild);
                            }
                        } else if (newIndex < realChildren.length) {
                            // ì¤‘ê°„ ìœ„ì¹˜: í•´ë‹¹ ìœ„ì¹˜ì˜ ì‹¤ì œ ìš”ì†Œ ì•ì— ì‚½ì…
                            const targetIndex = newIndex + (dummyElement ? 1 : 0);
                            const nextSibling = allChildren[targetIndex];
                            if (nextSibling && nextSibling !== item.cardElement && !nextSibling.classList.contains('masonry-dummy')) {
                                grid.insertBefore(item.cardElement, nextSibling);
                            } else {
                                grid.appendChild(item.cardElement);
                            }
                        } else {
                            // ë§ˆì§€ë§‰ ìœ„ì¹˜
                            grid.appendChild(item.cardElement);
                        }
                    }
                    
                    // ì¹´ë“œ ID ì—…ë°ì´íŠ¸
                    item.cardElement.id = `card-${newIndex}`;
                    
                    // ë‚´ë¶€ ìš”ì†Œë“¤ì˜ IDë„ ì—…ë°ì´íŠ¸ (querySelectorëŠ” IDê°€ ë³€ê²½ë˜ê¸° ì „ì— ì°¾ì•„ì•¼ í•¨)
                    const oldIndex = item.index;
                    
                    // ëª¨ë“  IDë¥¼ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸
                    const updateElementId = (selector, newId) => {
                        const element = item.cardElement.querySelector(selector);
                        if (element) {
                            element.id = newId;
                        }
                    };
                    
                    updateElementId(`#video-${oldIndex}`, `video-${newIndex}`);
                    updateElementId(`#overlay-${oldIndex}`, `overlay-${newIndex}`);
                    updateElementId(`#analysis-${oldIndex}`, `analysis-${newIndex}`);
                    updateElementId(`#analysis-text-${oldIndex}`, `analysis-text-${newIndex}`);
                    updateElementId(`#bit-info-${oldIndex}`, `bit-info-${newIndex}`);
                    updateElementId(`#bit-max-${oldIndex}`, `bit-max-${newIndex}`);
                    updateElementId(`#bit-min-${oldIndex}`, `bit-min-${newIndex}`);
                    updateElementId(`#bit-avg-10-${oldIndex}`, `bit-avg-10-${newIndex}`);
                    updateElementId(`#bit-avg-30-${oldIndex}`, `bit-avg-30-${newIndex}`);
                    updateElementId(`#bit-avg-60-${oldIndex}`, `bit-avg-60-${newIndex}`);
                    updateElementId(`#bit-array-${oldIndex}`, `bit-array-${newIndex}`);
                    updateElementId(`#status-${oldIndex}`, `status-${newIndex}`);
                    
                    // ë²„íŠ¼ì˜ onclick ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸
                    const editBtn = item.cardElement.querySelector(`button[onclick*="editCamera(${oldIndex})"]`);
                    if (editBtn) {
                        editBtn.setAttribute('onclick', `editCamera(${newIndex})`);
                    }
                    
                    const fullscreenBtn = item.cardElement.querySelector(`button[onclick*="openFullscreen(${oldIndex})"]`);
                    if (fullscreenBtn) {
                        fullscreenBtn.setAttribute('onclick', `openFullscreen(${newIndex})`);
                    }
                    
                    const deleteBtn = item.cardElement.querySelector(`button[onclick*="deleteCamera(${oldIndex})"]`);
                    if (deleteBtn) {
                        deleteBtn.setAttribute('onclick', `deleteCamera(${newIndex})`);
                    }
                }
            });

            // ì‚¬ì´ë“œë°” ëª©ë¡ ì—…ë°ì´íŠ¸
            renderCameraList();

            // Masonry ë ˆì´ì•„ì›ƒ ì—…ë°ì´íŠ¸ (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
            if (masonryInstance) {
                // ì§§ì€ ì§€ì—° í›„ ë ˆì´ì•„ì›ƒ ì—…ë°ì´íŠ¸ (DOM ë³€ê²½ì´ ì™„ë£Œëœ í›„)
                setTimeout(() => {
                    masonryInstance.reloadItems();
                    masonryInstance.layout();
                    
                    // ì •ë ¬ ì™„ë£Œ ì• ë‹ˆë©”ì´ì…˜
                    setTimeout(() => {
                        grid.classList.remove('sorting');
                        allCards.forEach(card => {
                            card.classList.remove('sorting');
                            card.classList.add('sorting-complete');
                            setTimeout(() => {
                                card.classList.remove('sorting-complete');
                            }, 500);
                        });
                    }, 100);
                }, 50);
            } else {
                // Masonryê°€ ì—†ëŠ” ê²½ìš°ì—ë„ ì •ë ¬ ì™„ë£Œ ì²˜ë¦¬
                setTimeout(() => {
                    grid.classList.remove('sorting');
                    allCards.forEach(card => {
                        card.classList.remove('sorting');
                        card.classList.add('sorting-complete');
                        setTimeout(() => {
                            card.classList.remove('sorting-complete');
                        }, 500);
                    });
                }, 100);
            }

            // ì •ë ¬ ì™„ë£Œ ë©”ì‹œì§€
            console.log('BIT MAX ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬ ì™„ë£Œ');
        }

        // ì‹¤ì‹œê°„ ì •ë ¬ í† ê¸€ (ì‹œê°„ë³„ í‰ê· ) - ë²„íŠ¼ë§Œ í™œì„±í™”, ì‹¤ì œ íƒ€ì´ë¨¸ëŠ” ì‹œì‘ ë²„íŠ¼ìœ¼ë¡œ ì œì–´
        function toggleRealtimeSort(seconds) {
            const btnId = `realtimeSortBtn${seconds}`;
            const btn = document.getElementById(btnId);
            const isActive = btn && btn.classList.contains('btn-active');
            
            // ë‹¤ë¥¸ ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
            [10, 30, 60].forEach(s => {
                const otherBtn = document.getElementById(`realtimeSortBtn${s}`);
                if (otherBtn && s !== seconds) {
                    otherBtn.classList.remove('btn-active');
                    otherBtn.textContent = `âš¡ ì‹¤ì‹œê°„ MAX ì •ë ¬ (${s}ì´ˆ)`;
                }
            });
            
            if (!isActive) {
                // ë²„íŠ¼ë§Œ í™œì„±í™” (íƒ€ì´ë¨¸ëŠ” ì‹œì‘í•˜ì§€ ì•ŠìŒ)
                btn.classList.add('btn-active');
                btn.textContent = `âš¡ ì‹¤ì‹œê°„ MAX ì •ë ¬ (${seconds}ì´ˆ) (ON)`;
                console.log(`ì‹¤ì‹œê°„ ì •ë ¬ ë²„íŠ¼ í™œì„±í™” (${seconds}ì´ˆ) - ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ì‘ë™í•©ë‹ˆë‹¤`);
            } else {
                // ë²„íŠ¼ ë¹„í™œì„±í™”
                btn.classList.remove('btn-active');
                btn.textContent = `âš¡ ì‹¤ì‹œê°„ MAX ì •ë ¬ (${seconds}ì´ˆ)`;
                
                // íƒ€ì´ë¨¸ê°€ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ì§€
                if (realtimeSortInterval) {
                    clearInterval(realtimeSortInterval);
                    realtimeSortInterval = null;
                }
                
                console.log('ì‹¤ì‹œê°„ ì •ë ¬ ë²„íŠ¼ ë¹„í™œì„±í™”');
            }
        }

        // ê²Œì´ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateProgressBar(progressBarId, progress) {
            const progressBar = document.getElementById(progressBarId);
            if (progressBar) {
                progressBar.style.width = Math.min(100, Math.max(0, progress)) + '%';
            }
        }

        // íƒ€ì´ë¨¸ ê²Œì´ì§€ ì• ë‹ˆë©”ì´ì…˜ (ê° íƒ€ì´ë¨¸ë³„ë¡œ ê´€ë¦¬)
        const progressAnimations = {};
        
        function startProgressAnimation(progressBarId, durationMs) {
            const progressBar = document.getElementById(progressBarId);
            if (!progressBar) return;
            
            // ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ ì •ë¦¬
            if (progressAnimations[progressBarId]) {
                clearInterval(progressAnimations[progressBarId].intervalId);
            }
            
            let startTime = Date.now();
            const updateInterval = 50; // 50msë§ˆë‹¤ ì—…ë°ì´íŠ¸
            
            const updateProgress = () => {
                const elapsed = Date.now() - startTime;
                const progress = (elapsed / durationMs) * 100;
                
                if (progress >= 100) {
                    updateProgressBar(progressBarId, 100);
                    // ì™„ë£Œ í›„ ì ì‹œ ëŒ€ê¸° í›„ ë¦¬ì…‹
                    setTimeout(() => {
                        updateProgressBar(progressBarId, 0);
                        if (progressAnimations[progressBarId]) {
                            clearInterval(progressAnimations[progressBarId].intervalId);
                            delete progressAnimations[progressBarId];
                        }
                    }, 100);
                } else {
                    updateProgressBar(progressBarId, progress);
                }
            };
            
            updateProgressBar(progressBarId, 0);
            const intervalId = setInterval(updateProgress, updateInterval);
            progressAnimations[progressBarId] = { intervalId, startTime };
        }
        
        function stopProgressAnimation(progressBarId) {
            if (progressAnimations[progressBarId]) {
                clearInterval(progressAnimations[progressBarId].intervalId);
                delete progressAnimations[progressBarId];
            }
            updateProgressBar(progressBarId, 0);
        }

        // ëª¨ë“  íƒ€ì´ë¨¸ ì‹œì‘/ì¤‘ì§€ (í†µí•© ë²„íŠ¼)
        function toggleAllTimers() {
            const btn = document.getElementById('allTimersToggleBtn');
            if (!btn) return;
            
            const isActive = btn.textContent.includes('ì¤‘ì§€');
            
            if (isActive) {
                // ëª¨ë“  íƒ€ì´ë¨¸ ì¤‘ì§€
                if (realtimeSortInterval) {
                    clearInterval(realtimeSortInterval);
                    realtimeSortInterval = null;
                }
                if (masonryReorderInterval) {
                    clearInterval(masonryReorderInterval);
                    masonryReorderInterval = null;
                }
                if (boundingBoxResetInterval) {
                    clearInterval(boundingBoxResetInterval);
                    boundingBoxResetInterval = null;
                }
                
                // ê²Œì´ì§€ ì• ë‹ˆë©”ì´ì…˜ ì •ë¦¬ ë° ë¦¬ì…‹
                stopProgressAnimation('repeatSecondsProgress');
                stopProgressAnimation('masonryReorderProgress');
                stopProgressAnimation('boundingBoxResetProgress');
                
                // ì‹¤ì‹œê°„ ì •ë ¬ ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
                [10, 30, 60].forEach(s => {
                    const sortBtn = document.getElementById(`realtimeSortBtn${s}`);
                    if (sortBtn) {
                        sortBtn.classList.remove('btn-active');
                        sortBtn.textContent = `âš¡ ì‹¤ì‹œê°„ MAX ì •ë ¬ (${s}ì´ˆ)`;
                    }
                });
                
                btn.textContent = 'íƒ€ì´ë¨¸ ì‹œì‘';
                console.log('ëª¨ë“  íƒ€ì´ë¨¸ ì¤‘ì§€');
            } else {
                // ëª¨ë“  íƒ€ì´ë¨¸ ì‹œì‘
                const repeatSecondsInput = document.getElementById('repeatSeconds');
                const masonryReorderTimerInput = document.getElementById('masonryReorderTimer');
                const boundingBoxResetTimerInput = document.getElementById('boundingBoxResetTimer');
                
                // ì‹¤ì‹œê°„ ì •ë ¬ íƒ€ì´ë¨¸ëŠ” í™œì„±í™”ëœ ë²„íŠ¼ì´ ìˆì„ ë•Œë§Œ ì‹œì‘
                const activeSortBtn = document.querySelector('.btn-active[id^="realtimeSortBtn"]');
                if (activeSortBtn) {
                    const btnId = activeSortBtn.id;
                    const seconds = parseInt(btnId.replace('realtimeSortBtn', ''));
                    const repeatSeconds = repeatSecondsInput ? parseInt(repeatSecondsInput.value) || 2 : 2;
                    const intervalMs = repeatSeconds * 1000;
                    
                    if (realtimeSortInterval) {
                        clearInterval(realtimeSortInterval);
                    }
                    
                    // ê²Œì´ì§€ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                    startProgressAnimation('repeatSecondsProgress', intervalMs);
                    
                    realtimeSortInterval = setInterval(() => {
                        sortByBitMaxAverage(seconds);
                        // ê²Œì´ì§€ ë‹¤ì‹œ ì‹œì‘
                        startProgressAnimation('repeatSecondsProgress', intervalMs);
                    }, intervalMs);
                    console.log(`ì‹¤ì‹œê°„ ì •ë ¬ íƒ€ì´ë¨¸ ì‹œì‘ (${repeatSeconds}ì´ˆ ê°„ê²©)`);
                }
                
                // Masonry ì¬ì •ë ¬ íƒ€ì´ë¨¸
                if (masonryReorderTimerInput) {
                    const masonrySeconds = parseInt(masonryReorderTimerInput.value) || 5;
                    const masonryIntervalMs = masonrySeconds * 1000;
                    if (masonryReorderInterval) {
                        clearInterval(masonryReorderInterval);
                    }
                    
                    // ê²Œì´ì§€ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                    startProgressAnimation('masonryReorderProgress', masonryIntervalMs);
                    
                    masonryReorderInterval = setInterval(() => {
                        if (masonryInstance) {
                            masonryInstance.reloadItems();
                            masonryInstance.layout();
                            console.log('Masonry ì¬ì •ë ¬ ì‹¤í–‰');
                        }
                        // ê²Œì´ì§€ ë‹¤ì‹œ ì‹œì‘
                        startProgressAnimation('masonryReorderProgress', masonryIntervalMs);
                    }, masonryIntervalMs);
                    console.log(`Masonry ì¬ì •ë ¬ íƒ€ì´ë¨¸ ì‹œì‘ (${masonrySeconds}ì´ˆ ê°„ê²©)`);
                }
                
                // ë°”ìš´ë”© ë°•ìŠ¤ ì´ˆê¸°í™” íƒ€ì´ë¨¸
                if (boundingBoxResetTimerInput) {
                    const boundingBoxSeconds = parseInt(boundingBoxResetTimerInput.value) || 10;
                    const boundingBoxIntervalMs = boundingBoxSeconds * 1000;
                    if (boundingBoxResetInterval) {
                        clearInterval(boundingBoxResetInterval);
                    }
                    
                    // ê²Œì´ì§€ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                    startProgressAnimation('boundingBoxResetProgress', boundingBoxIntervalMs);
                    
                    boundingBoxResetInterval = setInterval(() => {
                        resetBoundingBoxes();
                        // ê²Œì´ì§€ ë‹¤ì‹œ ì‹œì‘
                        startProgressAnimation('boundingBoxResetProgress', boundingBoxIntervalMs);
                    }, boundingBoxIntervalMs);
                    console.log(`ë°”ìš´ë”© ë°•ìŠ¤ ì´ˆê¸°í™” íƒ€ì´ë¨¸ ì‹œì‘ (${boundingBoxSeconds}ì´ˆ ê°„ê²©)`);
                }
                
                btn.textContent = 'íƒ€ì´ë¨¸ ì¤‘ì§€';
                console.log('ëª¨ë“  íƒ€ì´ë¨¸ ì‹œì‘');
            }
        }

        // Masonry ìˆ˜ë™ ì •ë ¬
        function reorderMasonry() {
            if (!masonryInstance) {
                // Masonry ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
                initMasonry();
                console.log('Masonry ì´ˆê¸°í™” ì™„ë£Œ');
            } else {
                // Masonry ì¬ì •ë ¬ ì‹¤í–‰
                masonryInstance.reloadItems();
                masonryInstance.layout();
                console.log('Masonry ìˆ˜ë™ ì •ë ¬ ì™„ë£Œ');
            }
        }

        // ë°”ìš´ë”© ë°•ìŠ¤ ì´ˆê¸°í™”
        function resetBoundingBoxes() {
            cameras.forEach((camera, index) => {
                if (analysisData[index]) {
                    // ë°”ìš´ë”© ë°•ìŠ¤ ì´ˆê¸°í™”
                    analysisData[index].boundingBoxes = [];
                    analysisData[index].trackedObjects = [];
                    
                    // ì˜¤ë²„ë ˆì´ ìº”ë²„ìŠ¤ í´ë¦¬ì–´
                    const overlayCanvas = document.getElementById(`overlay-${index}`);
                    if (overlayCanvas) {
                        const ctx = overlayCanvas.getContext('2d');
                        ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                    }
                }
            });
            console.log('ëª¨ë“  ë°”ìš´ë”© ë°•ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ');
        }


        // BIT MAX í‰ê· ê°’ìœ¼ë¡œ ì •ë ¬
        function sortByBitMaxAverage(seconds) {
            const grid = document.getElementById('cameraGrid');
            if (!grid) return;

            // ì •ë ¬ ì‹œì‘ í‘œì‹œ
            grid.classList.add('sorting');
            let allCards = grid.querySelectorAll('.camera-card');
            allCards.forEach(card => {
                card.classList.add('sorting');
            });

            // ê° ì¹´ë©”ë¼ì˜ BIT MAX í‰ê· ê°’ì„ ê°€ì ¸ì™€ì„œ ì •ë ¬
            const camerasWithBit = cameras.map((camera, index) => {
                const avg = calculateBitAverage(index, seconds);
                let bitAvg = 0;
                if (avg !== null && !isNaN(avg)) {
                    bitAvg = avg;
                } else {
                    // í‰ê· ê°’ì´ ì—†ìœ¼ë©´ í˜„ì¬ BIT MAX ê°’ ì‚¬ìš©
                    const bitMaxElement = document.getElementById(`bit-max-${index}`);
                    if (bitMaxElement && bitMaxElement.textContent !== 'ê³„ì‚° ì¤‘...' && bitMaxElement.textContent !== 'ì˜¤ë¥˜') {
                        const value = parseFloat(bitMaxElement.textContent);
                        if (!isNaN(value)) {
                            bitAvg = value;
                        }
                    }
                }
                return { 
                    camera, 
                    index, 
                    bitAvg, 
                    cardElement: document.getElementById(`card-${index}`),
                    analysisData: analysisData[index] || {}
                };
            });

            // BIT MAX í‰ê· ê°’ì´ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
            camerasWithBit.sort((a, b) => b.bitAvg - a.bitAvg);

            // ì •ë ¬ëœ ìˆœì„œë¡œ cameras ë°°ì—´ ì¬êµ¬ì„±
            const newCameras = [];
            const newAnalysisData = {};
            
            camerasWithBit.forEach((item, newIndex) => {
                newCameras.push(item.camera);
                newAnalysisData[newIndex] = item.analysisData;
            });
            
            cameras = newCameras;
            analysisData = newAnalysisData;

            // DOM ìˆœì„œë§Œ ë³€ê²½ (ì¬ë Œë”ë§ ì—†ì´)
            allCards = grid.querySelectorAll('.camera-card');
            allCards.forEach(card => {
                card.style.opacity = '1';
                card.style.visibility = 'visible';
                card.style.transition = 'transform 1.2s ease, opacity 0.3s ease';
            });

            // ì •ë ¬ëœ ìˆœì„œëŒ€ë¡œ ì¹´ë“œë¥¼ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— ë°°ì¹˜
            camerasWithBit.forEach((item, newIndex) => {
                if (item.cardElement && item.cardElement.parentNode === grid) {
                    item.cardElement.style.opacity = '1';
                    item.cardElement.style.visibility = 'visible';
                    
                    // í˜„ì¬ DOMì—ì„œì˜ ìœ„ì¹˜ í™•ì¸ (ë”ë¯¸ ìš”ì†Œ ì œì™¸)
                    const children = Array.from(grid.children).filter(child => !child.classList.contains('masonry-dummy'));
                    const currentIndex = children.indexOf(item.cardElement);
                    
                    // ìƒˆ ìœ„ì¹˜ê°€ í˜„ì¬ ìœ„ì¹˜ì™€ ë‹¤ë¥¼ ë•Œë§Œ ì´ë™ (ë”ë¯¸ ìš”ì†Œ ê³ ë ¤)
                    if (currentIndex !== newIndex) {
                        const allChildren = Array.from(grid.children);
                        const realChildren = allChildren.filter(child => !child.classList.contains('masonry-dummy'));
                        const dummyElement = allChildren.find(child => child.classList.contains('masonry-dummy'));
                        
                        // ë”ë¯¸ ìš”ì†Œ ë‹¤ìŒ ìœ„ì¹˜ì— ì‚½ì…
                        if (newIndex === 0 && dummyElement) {
                            // ì²« ë²ˆì§¸ ìœ„ì¹˜: ë”ë¯¸ ìš”ì†Œ ë‹¤ìŒì— ì‚½ì…
                            if (dummyElement.nextSibling && dummyElement.nextSibling !== item.cardElement) {
                                grid.insertBefore(item.cardElement, dummyElement.nextSibling);
                            } else {
                                grid.insertBefore(item.cardElement, dummyElement.nextSibling);
                            }
                        } else if (newIndex < realChildren.length) {
                            // ì¤‘ê°„ ìœ„ì¹˜: í•´ë‹¹ ìœ„ì¹˜ì˜ ì‹¤ì œ ìš”ì†Œ ì•ì— ì‚½ì…
                            const targetIndex = newIndex + (dummyElement ? 1 : 0);
                            const nextSibling = allChildren[targetIndex];
                            if (nextSibling && nextSibling !== item.cardElement && !nextSibling.classList.contains('masonry-dummy')) {
                                grid.insertBefore(item.cardElement, nextSibling);
                            } else {
                                grid.appendChild(item.cardElement);
                            }
                        } else {
                            // ë§ˆì§€ë§‰ ìœ„ì¹˜
                            grid.appendChild(item.cardElement);
                        }
                    }
                    
                    // ì¹´ë“œ ID ì—…ë°ì´íŠ¸
                    item.cardElement.id = `card-${newIndex}`;
                    
                    // ë‚´ë¶€ ìš”ì†Œë“¤ì˜ IDë„ ì—…ë°ì´íŠ¸
                    const oldIndex = item.index;
                    const updateElementId = (selector, newId) => {
                        const element = item.cardElement.querySelector(selector);
                        if (element) {
                            element.id = newId;
                        }
                    };
                    
                    updateElementId(`#video-${oldIndex}`, `video-${newIndex}`);
                    updateElementId(`#overlay-${oldIndex}`, `overlay-${newIndex}`);
                    updateElementId(`#analysis-${oldIndex}`, `analysis-${newIndex}`);
                    updateElementId(`#analysis-text-${oldIndex}`, `analysis-text-${newIndex}`);
                    updateElementId(`#bit-info-${oldIndex}`, `bit-info-${newIndex}`);
                    updateElementId(`#bit-max-${oldIndex}`, `bit-max-${newIndex}`);
                    updateElementId(`#bit-min-${oldIndex}`, `bit-min-${newIndex}`);
                    updateElementId(`#bit-avg-10-${oldIndex}`, `bit-avg-10-${newIndex}`);
                    updateElementId(`#bit-avg-30-${oldIndex}`, `bit-avg-30-${newIndex}`);
                    updateElementId(`#bit-avg-60-${oldIndex}`, `bit-avg-60-${newIndex}`);
                    updateElementId(`#bit-array-${oldIndex}`, `bit-array-${newIndex}`);
                    updateElementId(`#status-${oldIndex}`, `status-${newIndex}`);
                    
                    // ë²„íŠ¼ì˜ onclick ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸
                    const editBtn = item.cardElement.querySelector(`button[onclick*="editCamera(${oldIndex})"]`);
                    if (editBtn) editBtn.setAttribute('onclick', `editCamera(${newIndex})`);
                    
                    const fullscreenBtn = item.cardElement.querySelector(`button[onclick*="openFullscreen(${oldIndex})"]`);
                    if (fullscreenBtn) fullscreenBtn.setAttribute('onclick', `openFullscreen(${newIndex})`);
                    
                    const deleteBtn = item.cardElement.querySelector(`button[onclick*="deleteCamera(${oldIndex})"]`);
                    if (deleteBtn) deleteBtn.setAttribute('onclick', `deleteCamera(${newIndex})`);
                }
            });

            // ì‚¬ì´ë“œë°” ëª©ë¡ ì—…ë°ì´íŠ¸
            renderCameraList();

            // Masonry ë ˆì´ì•„ì›ƒ ì—…ë°ì´íŠ¸ (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
            if (masonryInstance) {
                setTimeout(() => {
                    masonryInstance.reloadItems();
                    masonryInstance.layout();
                    
                    // ì •ë ¬ ì™„ë£Œ ì• ë‹ˆë©”ì´ì…˜
                    setTimeout(() => {
                        grid.classList.remove('sorting');
                        allCards.forEach(card => {
                            card.classList.remove('sorting');
                            card.classList.add('sorting-complete');
                            setTimeout(() => {
                                card.classList.remove('sorting-complete');
                            }, 500);
                        });
                    }, 100);
                }, 50);
            } else {
                setTimeout(() => {
                    grid.classList.remove('sorting');
                    allCards.forEach(card => {
                        card.classList.remove('sorting');
                        card.classList.add('sorting-complete');
                        setTimeout(() => {
                            card.classList.remove('sorting-complete');
                        }, 500);
                    });
                }, 100);
            }

            console.log(`BIT MAX í‰ê·  (${seconds}ì´ˆ) ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬ ì™„ë£Œ`);
        }

        // BIT MIN ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
        function sortByBitMin() {
            const grid = document.getElementById('cameraGrid');
            if (!grid) return;

            // ì •ë ¬ ì‹œì‘ í‘œì‹œ
            grid.classList.add('sorting');
            let allCards = grid.querySelectorAll('.camera-card');
            allCards.forEach(card => {
                card.classList.add('sorting');
            });

            // ê° ì¹´ë©”ë¼ì˜ BIT MIN ê°’ì„ ê°€ì ¸ì™€ì„œ ì •ë ¬
            const camerasWithBit = cameras.map((camera, index) => {
                const bitMinElement = document.getElementById(`bit-min-${index}`);
                let bitMin = 0;
                if (bitMinElement && bitMinElement.textContent !== 'ê³„ì‚° ì¤‘...' && bitMinElement.textContent !== 'ì˜¤ë¥˜') {
                    const value = parseFloat(bitMinElement.textContent);
                    if (!isNaN(value)) {
                        bitMin = value;
                    }
                }
                return { 
                    camera, 
                    index, 
                    bitMin, 
                    cardElement: document.getElementById(`card-${index}`),
                    analysisData: analysisData[index] || {}
                };
            });

            // BIT MIN ê°’ì´ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
            camerasWithBit.sort((a, b) => b.bitMin - a.bitMin);

            // ì •ë ¬ëœ ìˆœì„œë¡œ cameras ë°°ì—´ ì¬êµ¬ì„±
            const newCameras = [];
            const newAnalysisData = {};
            
            camerasWithBit.forEach((item, newIndex) => {
                newCameras.push(item.camera);
                newAnalysisData[newIndex] = item.analysisData;
            });
            
            cameras = newCameras;
            analysisData = newAnalysisData;

            // DOM ìˆœì„œë§Œ ë³€ê²½ (ì¬ë Œë”ë§ ì—†ì´)
            allCards = grid.querySelectorAll('.camera-card');
            allCards.forEach(card => {
                card.style.opacity = '1';
                card.style.visibility = 'visible';
                card.style.transition = 'transform 1.2s ease, opacity 0.3s ease';
            });

            camerasWithBit.forEach((item, newIndex) => {
                if (item.cardElement && item.cardElement.parentNode === grid) {
                    item.cardElement.style.opacity = '1';
                    item.cardElement.style.visibility = 'visible';
                    
                    // í˜„ì¬ DOMì—ì„œì˜ ìœ„ì¹˜ í™•ì¸ (ë”ë¯¸ ìš”ì†Œ ì œì™¸)
                    const children = Array.from(grid.children).filter(child => !child.classList.contains('masonry-dummy'));
                    const currentIndex = children.indexOf(item.cardElement);
                    
                    // ìƒˆ ìœ„ì¹˜ê°€ í˜„ì¬ ìœ„ì¹˜ì™€ ë‹¤ë¥¼ ë•Œë§Œ ì´ë™
                    if (currentIndex !== newIndex) {
                        const allChildren = Array.from(grid.children);
                        const dummyElement = allChildren.find(child => child.classList.contains('masonry-dummy'));
                        const realChildren = allChildren.filter(child => !child.classList.contains('masonry-dummy'));
                        
                        if (newIndex === 0) {
                            // ì²« ë²ˆì§¸ ìœ„ì¹˜: ë”ë¯¸ ìš”ì†Œ ë‹¤ìŒì— ì‚½ì…
                            if (dummyElement) {
                                if (dummyElement.nextSibling && dummyElement.nextSibling !== item.cardElement) {
                                    grid.insertBefore(item.cardElement, dummyElement.nextSibling);
                                } else {
                                    grid.insertBefore(item.cardElement, dummyElement.nextSibling);
                                }
                            } else {
                                grid.insertBefore(item.cardElement, grid.firstChild);
                            }
                        } else if (newIndex < realChildren.length) {
                            // ì¤‘ê°„ ìœ„ì¹˜: í•´ë‹¹ ìœ„ì¹˜ì˜ ì‹¤ì œ ìš”ì†Œ ì•ì— ì‚½ì…
                            const targetIndex = newIndex + (dummyElement ? 1 : 0);
                            const nextSibling = allChildren[targetIndex];
                            if (nextSibling && nextSibling !== item.cardElement && !nextSibling.classList.contains('masonry-dummy')) {
                                grid.insertBefore(item.cardElement, nextSibling);
                            } else {
                                grid.appendChild(item.cardElement);
                            }
                        } else {
                            // ë§ˆì§€ë§‰ ìœ„ì¹˜
                            grid.appendChild(item.cardElement);
                        }
                    }
                    
                    // ì¹´ë“œ ID ì—…ë°ì´íŠ¸
                    item.cardElement.id = `card-${newIndex}`;
                    
                    // ë‚´ë¶€ ìš”ì†Œë“¤ì˜ IDë„ ì—…ë°ì´íŠ¸
                    const videoElement = item.cardElement.querySelector(`#video-${item.index}`);
                    if (videoElement) videoElement.id = `video-${newIndex}`;
                    
                    const overlayElement = item.cardElement.querySelector(`#overlay-${item.index}`);
                    if (overlayElement) overlayElement.id = `overlay-${newIndex}`;
                    
                    const analysisElement = item.cardElement.querySelector(`#analysis-${item.index}`);
                    if (analysisElement) analysisElement.id = `analysis-${newIndex}`;
                    
                    const analysisTextElement = item.cardElement.querySelector(`#analysis-text-${item.index}`);
                    if (analysisTextElement) analysisTextElement.id = `analysis-text-${newIndex}`;
                    
                    const bitInfoElement = item.cardElement.querySelector(`#bit-info-${item.index}`);
                    if (bitInfoElement) bitInfoElement.id = `bit-info-${newIndex}`;
                    
                    const bitMaxElement = item.cardElement.querySelector(`#bit-max-${item.index}`);
                    if (bitMaxElement) bitMaxElement.id = `bit-max-${newIndex}`;
                    
                    const bitMinElement = item.cardElement.querySelector(`#bit-min-${item.index}`);
                    if (bitMinElement) bitMinElement.id = `bit-min-${newIndex}`;
                    
                    const bitArrayElement = item.cardElement.querySelector(`#bit-array-${item.index}`);
                    if (bitArrayElement) bitArrayElement.id = `bit-array-${newIndex}`;
                    
                    const statusElement = item.cardElement.querySelector(`#status-${item.index}`);
                    if (statusElement) statusElement.id = `status-${newIndex}`;
                    
                    // ë²„íŠ¼ì˜ onclick ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸
                    const editBtn = item.cardElement.querySelector(`button[onclick*="editCamera(${item.index})"]`);
                    if (editBtn) editBtn.setAttribute('onclick', `editCamera(${newIndex})`);
                    
                    const fullscreenBtn = item.cardElement.querySelector(`button[onclick*="openFullscreen(${item.index})"]`);
                    if (fullscreenBtn) fullscreenBtn.setAttribute('onclick', `openFullscreen(${newIndex})`);
                    
                    const deleteBtn = item.cardElement.querySelector(`button[onclick*="deleteCamera(${item.index})"]`);
                    if (deleteBtn) deleteBtn.setAttribute('onclick', `deleteCamera(${newIndex})`);
                }
            });

            // ì‚¬ì´ë“œë°” ëª©ë¡ ì—…ë°ì´íŠ¸
            renderCameraList();

            // Masonry ë ˆì´ì•„ì›ƒ ì—…ë°ì´íŠ¸ (ì• ë‹ˆë©”ì´ì…˜ í¬í•¨)
            if (masonryInstance) {
                setTimeout(() => {
                    masonryInstance.reloadItems();
                    masonryInstance.layout();
                    
                    // ì •ë ¬ ì™„ë£Œ ì• ë‹ˆë©”ì´ì…˜
                    setTimeout(() => {
                        grid.classList.remove('sorting');
                        allCards.forEach(card => {
                            card.classList.remove('sorting');
                            card.classList.add('sorting-complete');
                            setTimeout(() => {
                                card.classList.remove('sorting-complete');
                            }, 500);
                        });
                    }, 100);
                }, 50);
            } else {
                // Masonryê°€ ì—†ëŠ” ê²½ìš°ì—ë„ ì •ë ¬ ì™„ë£Œ ì²˜ë¦¬
                setTimeout(() => {
                    grid.classList.remove('sorting');
                    allCards.forEach(card => {
                        card.classList.remove('sorting');
                        card.classList.add('sorting-complete');
                        setTimeout(() => {
                            card.classList.remove('sorting-complete');
                        }, 500);
                    });
                }, 100);
            }

            // ì •ë ¬ ì™„ë£Œ ë©”ì‹œì§€
            console.log('BIT MIN ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬ ì™„ë£Œ');
        }

        // ì „ì²´ ì‚­ì œ
        function clearAllCameras() {
            if (confirm('ëª¨ë“  ì¹´ë©”ë¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                cameras = [];
                saveCameras();
                renderCameras();
                renderCameraList();
            }
        }

        // ì „ì²´í™”ë©´ ë³´ê¸°
        function openFullscreen(index) {
            const camera = cameras[index];
            const fullscreen = document.getElementById('fullscreen');
            const video = document.getElementById('fullscreenVideo');
            
            if (camera.url.startsWith('rtsp://')) {
                alert('RTSP ìŠ¤íŠ¸ë¦¼ì€ ì „ì²´í™”ë©´ ì¬ìƒì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            // ì›¹ì‚¬ì´íŠ¸ URLì¸ ê²½ìš° iframeìœ¼ë¡œ í‘œì‹œ
            if ((camera.url.startsWith('http://') || camera.url.startsWith('https://')) && 
                !camera.url.match(/\.(m3u8|mp4|avi|mov|webm|jpg|jpeg|png|gif|mjpeg|video)(\?|$)/i) &&
                !camera.url.includes('/video') && !camera.url.includes('/stream') && !camera.url.includes('/mjpeg')) {
                video.innerHTML = '';
                video.style.display = 'none';
                const iframe = document.createElement('iframe');
                iframe.src = camera.url;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.allowFullscreen = true;
                fullscreen.appendChild(iframe);
            } else             if (camera.url.includes('.m3u8') || camera.url.includes('chunklist')) {
                // HLS ìŠ¤íŠ¸ë¦¼
                if (typeof Hls !== 'undefined' && Hls.isSupported()) {
                    const hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true
                    });
                    hls.loadSource(camera.url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        video.play();
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = camera.url;
                    video.play();
                } else {
                    alert('HLS ìŠ¤íŠ¸ë¦¼ì„ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. HLS.jsê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }
            } else if (camera.url.includes('.jpg') || camera.url.includes('.jpeg')) {
                video.innerHTML = '';
                video.style.display = 'none';
                const img = document.createElement('img');
                img.src = camera.url;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                fullscreen.appendChild(img);
            } else {
                video.innerHTML = `<source src="${camera.url}" type="video/mp4">`;
            }

            fullscreen.classList.add('active');
            if (video && video.innerHTML) {
                video.load();
                video.play();
            }
        }

        // ì „ì²´í™”ë©´ ë‹«ê¸°
        function closeFullscreen() {
            const fullscreen = document.getElementById('fullscreen');
            const video = document.getElementById('fullscreenVideo');
            fullscreen.classList.remove('active');
            if (video) {
                video.pause();
                video.innerHTML = '';
                video.style.display = 'block';
            }
            // ì´ë¯¸ì§€ ì œê±°
            const img = fullscreen.querySelector('img');
            if (img) img.remove();
            // iframe ì œê±°
            const iframe = fullscreen.querySelector('iframe');
            if (iframe) iframe.remove();
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeFullscreen();
            }
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('cameraModal').addEventListener('click', (e) => {
            if (e.target.id === 'cameraModal') {
                closeModal();
            }
        });

        // XML ê°€ì ¸ì˜¤ê¸° ëª¨ë‹¬
        let xmlMode = 'api';

        function openXmlImportModal() {
            document.getElementById('xmlModal').classList.add('active');
            document.getElementById('xmlApiUrl').value = '';
            document.getElementById('xmlText').value = '';
            document.getElementById('xmlResult').style.display = 'none';
            switchXmlMode('api');
        }

        function closeXmlModal() {
            document.getElementById('xmlModal').classList.remove('active');
        }

        function switchXmlMode(mode) {
            xmlMode = mode;
            const apiGroup = document.getElementById('xmlApiGroup');
            const textGroup = document.getElementById('xmlTextGroup');
            const apiBtn = document.getElementById('xmlModeApi');
            const textBtn = document.getElementById('xmlModeText');

            if (mode === 'api') {
                apiGroup.style.display = 'block';
                textGroup.style.display = 'none';
                apiBtn.style.background = '#4CAF50';
                textBtn.style.background = '#555';
            } else {
                apiGroup.style.display = 'none';
                textGroup.style.display = 'block';
                apiBtn.style.background = '#555';
                textBtn.style.background = '#4CAF50';
            }
        }

        // XML íŒŒì‹± í•¨ìˆ˜
        function parseXmlData(xmlString) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
                
                // ì—ëŸ¬ ì²´í¬
                const parserError = xmlDoc.querySelector('parsererror');
                if (parserError) {
                    throw new Error('XML íŒŒì‹± ì˜¤ë¥˜: ' + parserError.textContent);
                }

                const dataElements = xmlDoc.querySelectorAll('data');
                const cameras = [];

                dataElements.forEach((data, index) => {
                    const name = data.querySelector('cctvname')?.textContent?.trim() || `CCTV ${index + 1}`;
                    const url = data.querySelector('cctvurl')?.textContent?.trim();
                    const format = data.querySelector('cctvformat')?.textContent?.trim() || '';
                    const coordx = data.querySelector('coordx')?.textContent?.trim() || '';
                    const coordy = data.querySelector('coordy')?.textContent?.trim() || '';

                    if (url) {
                        // HLS í˜•ì‹ì¸ ê²½ìš° .m3u8 ì¶”ê°€ (ì—†ëŠ” ê²½ìš°)
                        let finalUrl = url;
                        if (format === 'HLS' && !url.includes('.m3u8')) {
                            finalUrl = url + (url.endsWith('/') ? '' : '/') + 'playlist.m3u8';
                        }

                        cameras.push({
                            name: name,
                            url: finalUrl,
                            format: format,
                            coordx: coordx,
                            coordy: coordy
                        });
                    }
                });

                return cameras;
            } catch (error) {
                throw new Error('XML íŒŒì‹± ì‹¤íŒ¨: ' + error.message);
            }
        }

        // XML ê°€ì ¸ì˜¤ê¸° ì‹¤í–‰
        async function importXml() {
            const resultDiv = document.getElementById('xmlResult');
            const resultText = document.getElementById('xmlResultText');
            resultDiv.style.display = 'block';
            resultText.textContent = 'ì²˜ë¦¬ ì¤‘...';
            resultText.style.color = '#4CAF50';

            try {
                let xmlData = '';

                if (xmlMode === 'api') {
                    const apiUrl = document.getElementById('xmlApiUrl').value.trim();
                    if (!apiUrl) {
                        throw new Error('API URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    }

                    // CORS í”„ë¡ì‹œ í•„ìš”í•  ìˆ˜ ìˆìŒ
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
                    }
                    xmlData = await response.text();
                } else {
                    xmlData = document.getElementById('xmlText').value.trim();
                    if (!xmlData) {
                        throw new Error('XML ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    }
                }

                const parsedCameras = parseXmlData(xmlData);

                if (parsedCameras.length === 0) {
                    throw new Error('íŒŒì‹±ëœ ì¹´ë©”ë¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }

                // ê¸°ì¡´ ì¹´ë©”ë¼ì— ì¶”ê°€
                cameras.push(...parsedCameras);
                saveCameras();
                renderCameras();
                renderCameraList();

                resultText.innerHTML = `
                    <div style="color: #4CAF50;">âœ… ì„±ê³µì ìœ¼ë¡œ ${parsedCameras.length}ê°œì˜ ì¹´ë©”ë¼ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤!</div>
                    <div style="margin-top: 10px; color: #888;">
                        ${parsedCameras.slice(0, 5).map(c => `â€¢ ${c.name}`).join('<br>')}
                        ${parsedCameras.length > 5 ? `<br>... ì™¸ ${parsedCameras.length - 5}ê°œ` : ''}
                    </div>
                `;
                resultText.style.color = '#4CAF50';

                // 3ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(() => {
                    closeXmlModal();
                }, 3000);

            } catch (error) {
                resultText.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
                resultText.style.color = '#f44336';
            }
        }

        // ì—¬ëŸ¬ URL ê°€ì ¸ì˜¤ê¸° ëª¨ë‹¬
        function openBulkImportModal() {
            document.getElementById('bulkImportModal').classList.add('active');
            document.getElementById('bulkUrls').value = '';
            document.getElementById('bulkNamePrefix').value = '';
            document.getElementById('bulkResult').style.display = 'none';
        }

        function closeBulkImportModal() {
            document.getElementById('bulkImportModal').classList.remove('active');
        }

        function importBulkUrls() {
            const resultDiv = document.getElementById('bulkResult');
            const resultText = document.getElementById('bulkResultText');
            resultDiv.style.display = 'block';
            resultText.textContent = 'ì²˜ë¦¬ ì¤‘...';
            resultText.style.color = '#4CAF50';

            try {
                const inputText = document.getElementById('bulkUrls').value.trim();
                const namePrefix = document.getElementById('bulkNamePrefix').value.trim();
                
                if (!inputText) {
                    throw new Error('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }

                let urls = [];

                // JSON ë°°ì—´ í˜•ì‹ì¸ì§€ í™•ì¸
                if (inputText.trim().startsWith('[') && inputText.trim().endsWith(']')) {
                    try {
                        urls = JSON.parse(inputText);
                        if (!Array.isArray(urls)) {
                            throw new Error('JSON ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                        }
                    } catch (e) {
                        throw new Error('JSON íŒŒì‹± ì‹¤íŒ¨: ' + e.message);
                    }
                } else {
                    // ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„ëœ URL ëª©ë¡
                    urls = inputText.split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0 && (line.startsWith('http://') || line.startsWith('https://')));
                }

                if (urls.length === 0) {
                    throw new Error('ìœ íš¨í•œ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                const newCameras = urls.map((url, index) => {
                    // URLì—ì„œ ì¹´ë©”ë¼ ì´ë¦„ ì¶”ì¶œ ì‹œë„
                    let name = '';
                    
                    // videoXX.stream íŒ¨í„´ì—ì„œ ë²ˆí˜¸ ì¶”ì¶œ
                    const videoMatch = url.match(/video(\d+)\.stream/);
                    if (videoMatch) {
                        name = `ì¹´ë©”ë¼ ${videoMatch[1]}`;
                    } else {
                        // URLì˜ ë§ˆì§€ë§‰ ë¶€ë¶„ì—ì„œ ì´ë¦„ ì¶”ì¶œ
                        const urlParts = url.split('/');
                        const lastPart = urlParts[urlParts.length - 1] || urlParts[urlParts.length - 2];
                        if (lastPart && lastPart.includes('video')) {
                            name = lastPart.replace(/\.(m3u8|stream)$/i, '');
                        } else {
                            name = `ì¹´ë©”ë¼ ${index + 1}`;
                        }
                    }

                    // ì ‘ë‘ì‚¬ ì¶”ê°€
                    if (namePrefix) {
                        name = `${namePrefix} ${name}`;
                    }

                    return {
                        name: name,
                        url: url
                    };
                });

                // ê¸°ì¡´ ì¹´ë©”ë¼ì— ì¶”ê°€
                cameras.push(...newCameras);
                saveCameras();
                renderCameras();
                renderCameraList();

                resultText.innerHTML = `
                    <div style="color: #4CAF50;">âœ… ì„±ê³µì ìœ¼ë¡œ ${newCameras.length}ê°œì˜ ì¹´ë©”ë¼ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤!</div>
                    <div style="margin-top: 10px; color: #888; max-height: 200px; overflow-y: auto;">
                        ${newCameras.slice(0, 10).map(c => `â€¢ ${c.name}`).join('<br>')}
                        ${newCameras.length > 10 ? `<br>... ì™¸ ${newCameras.length - 10}ê°œ` : ''}
                    </div>
                `;
                resultText.style.color = '#4CAF50';

                // 3ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(() => {
                    closeBulkImportModal();
                }, 3000);

            } catch (error) {
                resultText.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message;
                resultText.style.color = '#f44336';
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° (XML ëª¨ë‹¬)
        document.getElementById('xmlModal').addEventListener('click', (e) => {
            if (e.target.id === 'xmlModal') {
                closeXmlModal();
            }
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° (Bulk Import ëª¨ë‹¬)
        document.getElementById('bulkImportModal').addEventListener('click', (e) => {
            if (e.target.id === 'bulkImportModal') {
                closeBulkImportModal();
            }
        });

        // íƒ€ì´ë¨¸ ì…ë ¥ë€ ê°’ ì €ì¥
        function saveTimerSettings() {
            const repeatSeconds = document.getElementById('repeatSeconds')?.value || '2';
            const masonryReorderTimer = document.getElementById('masonryReorderTimer')?.value || '5';
            const boundingBoxResetTimer = document.getElementById('boundingBoxResetTimer')?.value || '10';
            
            localStorage.setItem('timerRepeatSeconds', repeatSeconds);
            localStorage.setItem('timerMasonryReorder', masonryReorderTimer);
            localStorage.setItem('timerBoundingBoxReset', boundingBoxResetTimer);
        }

        // íƒ€ì´ë¨¸ ì…ë ¥ë€ ê°’ ë¡œë“œ
        function loadTimerSettings() {
            const repeatSecondsInput = document.getElementById('repeatSeconds');
            const masonryReorderTimerInput = document.getElementById('masonryReorderTimer');
            const boundingBoxResetTimerInput = document.getElementById('boundingBoxResetTimer');
            
            if (repeatSecondsInput) {
                const saved = localStorage.getItem('timerRepeatSeconds');
                if (saved) {
                    repeatSecondsInput.value = saved;
                }
            }
            
            if (masonryReorderTimerInput) {
                const saved = localStorage.getItem('timerMasonryReorder');
                if (saved) {
                    masonryReorderTimerInput.value = saved;
                }
            }
            
            if (boundingBoxResetTimerInput) {
                const saved = localStorage.getItem('timerBoundingBoxReset');
                if (saved) {
                    boundingBoxResetTimerInput.value = saved;
                }
            }
        }

        // ë°˜ë³µ ì´ˆ ì…ë ¥ë€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ìë™ ì €ì¥)
        const repeatSecondsInput = document.getElementById('repeatSeconds');
        if (repeatSecondsInput) {
            // ê°’ ë³€ê²½ ì‹œ ìë™ ì €ì¥
            repeatSecondsInput.addEventListener('input', () => {
                saveTimerSettings();
            });
            repeatSecondsInput.addEventListener('change', () => {
                saveTimerSettings();
            });
        }

        // Masonry ì¬ì •ë ¬ íƒ€ì´ë¨¸ ì…ë ¥ë€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ìë™ ì €ì¥)
        const masonryReorderTimerInput = document.getElementById('masonryReorderTimer');
        if (masonryReorderTimerInput) {
            masonryReorderTimerInput.addEventListener('input', () => {
                saveTimerSettings();
            });
            masonryReorderTimerInput.addEventListener('change', () => {
                saveTimerSettings();
            });
        }

        // ë°”ìš´ë”© ë°•ìŠ¤ ì´ˆê¸°í™” íƒ€ì´ë¨¸ ì…ë ¥ë€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ìë™ ì €ì¥)
        const boundingBoxResetTimerInput = document.getElementById('boundingBoxResetTimer');
        if (boundingBoxResetTimerInput) {
            boundingBoxResetTimerInput.addEventListener('input', () => {
                saveTimerSettings();
            });
            boundingBoxResetTimerInput.addEventListener('change', () => {
                saveTimerSettings();
            });
        }

        // Motion Detection & Object Tracking ë³€ìˆ˜
        let cvReady = false;
        let analysisData = {}; // ê° ì¹´ë©”ë¼ì˜ ë¶„ì„ ë°ì´í„° ì €ì¥
        const trackers = {}; // ê°ì²´ ì¶”ì ê¸° ì €ì¥
        const previousFrames = {}; // ì´ì „ í”„ë ˆì„ ì €ì¥
        let realtimeSortActive = false; // ì‹¤ì‹œê°„ ì •ë ¬ í™œì„±í™” ìƒíƒœ
        let realtimeSortInterval = null; // ì‹¤ì‹œê°„ ì •ë ¬ ì¸í„°ë²Œ
        let masonryReorderInterval = null; // Masonry ì¬ì •ë ¬ ì¸í„°ë²Œ
        let boundingBoxResetInterval = null; // ë°”ìš´ë”© ë°•ìŠ¤ ì´ˆê¸°í™” ì¸í„°ë²Œ
        const bitMaxHistory = {}; // ê° ì¹´ë©”ë¼ì˜ BIT MAX ê°’ ì‹œê°„ë³„ ê¸°ë¡ {index: [{value, timestamp}, ...]}

        // OpenCV.js ë¡œë“œ í™•ì¸
        function checkOpenCV() {
            if (typeof cv !== 'undefined') {
                cvReady = true;
                console.log('OpenCV.js ë¡œë“œ ì™„ë£Œ');
                startAnalysis();
            } else {
                setTimeout(checkOpenCV, 100);
            }
        }

        // ë¶„ì„ ì‹œì‘
        function startAnalysis() {
            if (!cvReady) {
                checkOpenCV();
                return;
            }

            cameras.forEach((camera, index) => {
                const video = document.getElementById(`video-${index}`);
                if (video && video.tagName === 'VIDEO') {
                    // ë¹„ë””ì˜¤ê°€ ë¡œë“œë˜ë©´ ë¶„ì„ ì‹œì‘
                    video.addEventListener('loadedmetadata', () => {
                        initAnalysis(index, video);
                    });
                    
                    // ì´ë¯¸ ë¡œë“œëœ ê²½ìš°
                    if (video.readyState >= 2) {
                        initAnalysis(index, video);
                    }
                }
            });
        }

        // ë¶„ì„ ì´ˆê¸°í™”
        function initAnalysis(index, video) {
            if (!analysisData[index]) {
                analysisData[index] = {
                    motionCount: 0,
                    objects: [], // ê°ì²´ ë°°ì—´
                    background: { // ë°°ê²½ ì†ì„±
                        averageBrightness: 0,
                        contrast: 0,
                        stability: 0,
                        dominantColor: null,
                        lastUpdate: Date.now()
                    },
                    trackedObjects: [],
                    boundingBoxes: [],
                    lastUpdate: Date.now()
                };
            }

            // ë¶„ì„ ë£¨í”„ ì‹œì‘
            analyzeFrame(index, video);
        }

        // í”„ë ˆì„ ë¶„ì„
        function analyzeFrame(index, video) {
            if (!video || video.readyState !== 4) {
                setTimeout(() => analyzeFrame(index, video), 100);
                return;
            }

            try {
                // Canvas ìƒì„±
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 480;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // OpenCV Mat ìƒì„±
                const src = cv.imread(canvas);
                const gray = new cv.Mat();
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

                // ë°°ê²½ ë¶„ì„
                analyzeBackground(index, src);

                // Motion Detection (ìƒ‰ìƒ ê³„ì‚°ì„ ìœ„í•´ srcë„ ì „ë‹¬)
                detectMotion(index, gray, src);

                // Object Tracking
                trackObjects(index, gray);

                // ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°
                drawBoundingBoxes(index, video);

                // ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸
                updateAnalysisText(index);

                // BIT ê³„ì‚° ë° í‘œì‹œ
                updateBitCalculation(index);

                // ë©”ëª¨ë¦¬ ì •ë¦¬
                src.delete();
                gray.delete();
                canvas.remove();

                // ë‹¤ìŒ í”„ë ˆì„ ë¶„ì„ (ì•½ 1ì´ˆë§ˆë‹¤)
                setTimeout(() => analyzeFrame(index, video), 1000);

            } catch (error) {
                console.error(`ì¹´ë©”ë¼ ${index} ë¶„ì„ ì˜¤ë¥˜:`, error);
                setTimeout(() => analyzeFrame(index, video), 2000);
            }
        }

        // ë°°ê²½ ë¶„ì„
        function analyzeBackground(index, frame) {
            let mean = null;
            let stddev = null;
            let diff = null;
            let diffMean = null;
            let diffStddev = null;
            
            try {
                if (!frame || frame.isDeleted() || frame.empty()) {
                    return;
                }

                if (!analysisData[index]) {
                    analysisData[index] = {
                        objects: [],
                        background: {}
                    };
                }

                // í‰ê·  ë°ê¸° ê³„ì‚°
                mean = new cv.Mat();
                stddev = new cv.Mat();
                cv.meanStdDev(frame, mean, stddev);
                
                if (!mean || mean.empty() || !stddev || stddev.empty()) {
                    return;
                }
                
                const brightness = mean.data64F ? mean.data64F[0] : 0;
                const contrast = stddev.data64F ? stddev.data64F[0] : 0;

                // ë°°ê²½ ì•ˆì •ì„± ê³„ì‚° (ì´ì „ í”„ë ˆì„ê³¼ ë¹„êµ)
                let stability = 100;
                if (previousFrames[index] && !previousFrames[index].isDeleted() && !previousFrames[index].empty()) {
                    try {
                        diff = new cv.Mat();
                        cv.absdiff(frame, previousFrames[index], diff);
                        
                        if (!diff || diff.empty()) {
                            stability = 100;
                        } else {
                            diffMean = new cv.Mat();
                            diffStddev = new cv.Mat();
                            cv.meanStdDev(diff, diffMean, diffStddev);
                            
                            if (diffMean && diffMean.data64F) {
                                const change = diffMean.data64F[0];
                                stability = Math.max(0, 100 - (change * 10)); // ë³€í™”ê°€ ì ì„ìˆ˜ë¡ ì•ˆì •ì„± ë†’ìŒ
                            }
                        }
                    } catch (e) {
                        // ì•ˆì •ì„± ê³„ì‚° ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
                        stability = 100;
                    }
                }

                // ë°°ê²½ ì†ì„± ì—…ë°ì´íŠ¸
                analysisData[index].background = {
                    averageBrightness: Math.round(brightness),
                    contrast: Math.round(contrast),
                    stability: Math.round(stability),
                    dominantColor: null, // ì¶”í›„ êµ¬í˜„ ê°€ëŠ¥
                    lastUpdate: Date.now()
                };

            } catch (error) {
                // OpenCV.js ë©”ëª¨ë¦¬ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë„ˆë¬´ ë§ì€ ë¡œê·¸ ë°©ì§€)
                // ìˆ«ìë§Œ ìˆëŠ” ì˜¤ë¥˜ëŠ” ë©”ëª¨ë¦¬ ì£¼ì†Œì´ë¯€ë¡œ ë¬´ì‹œ
                const errorStr = String(error);
                if (errorStr && !/^\d+$/.test(errorStr) && errorStr.length > 5) {
                    // ì‹¤ì œ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ë¡œê·¸
                    if (error.message && !error.message.includes('Cannot access') && !error.message.includes('Invalid')) {
                        console.warn(`ë°°ê²½ ë¶„ì„ ê²½ê³  (ì¹´ë©”ë¼ ${index}):`, error.message);
                    }
                }
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ê°’ ì„¤ì •
                if (!analysisData[index]) {
                    analysisData[index] = {};
                }
                if (!analysisData[index].background) {
                    analysisData[index].background = {
                        averageBrightness: 0,
                        contrast: 0,
                        stability: 0,
                        lastUpdate: Date.now()
                    };
                }
            } finally {
                // ë©”ëª¨ë¦¬ ì •ë¦¬ ë³´ì¥
                try {
                    if (mean && !mean.isDeleted()) mean.delete();
                } catch (e) {}
                try {
                    if (stddev && !stddev.isDeleted()) stddev.delete();
                } catch (e) {}
                try {
                    if (diff && !diff.isDeleted()) diff.delete();
                } catch (e) {}
                try {
                    if (diffMean && !diffMean.isDeleted()) diffMean.delete();
                } catch (e) {}
                try {
                    if (diffStddev && !diffStddev.isDeleted()) diffStddev.delete();
                } catch (e) {}
            }
        }

        // ê°ì²´ ì˜ì—­ì˜ í‰ê·  ìƒ‰ìƒ ê³„ì‚°
        function calculateObjectColor(srcFrame, x, y, width, height) {
            try {
                // ROI (Region of Interest) ì¶”ì¶œ
                const rect = new cv.Rect(x, y, width, height);
                const roi = srcFrame.roi(rect);
                
                // í‰ê·  ìƒ‰ìƒ ê³„ì‚°
                const mean = new cv.Mat();
                const stddev = new cv.Mat();
                cv.meanStdDev(roi, mean, stddev);
                
                // BGR ìˆœì„œ (OpenCVëŠ” BGR ì‚¬ìš©)
                const b = Math.round(mean.data64F[0] || 0);
                const g = Math.round(mean.data64F[1] || 0);
                const r = Math.round(mean.data64F[2] || 0);
                
                // ë©”ëª¨ë¦¬ ì •ë¦¬
                mean.delete();
                stddev.delete();
                roi.delete();
                
                return { r, g, b };
            } catch (error) {
                console.error('ìƒ‰ìƒ ê³„ì‚° ì˜¤ë¥˜:', error);
                return { r: 0, g: 0, b: 0 };
            }
        }

        // RGBë¥¼ ìƒ‰ìƒ ì´ë¦„ìœ¼ë¡œ ë³€í™˜ (ê°„ë‹¨í•œ ë¶„ë¥˜)
        function getColorName(r, g, b) {
            // ë°ê¸° ê³„ì‚°
            const brightness = (r + g + b) / 3;
            
            // ì±„ë„ ê³„ì‚°
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            const saturation = max === 0 ? 0 : (max - min) / max;
            
            if (brightness < 30) return 'ê²€ì •';
            if (brightness > 220) return 'í°ìƒ‰';
            if (saturation < 0.2) return 'íšŒìƒ‰';
            
            // ì£¼ìš” ìƒ‰ìƒ íŒë³„
            if (r > g + 30 && r > b + 30) return 'ë¹¨ê°•';
            if (g > r + 30 && g > b + 30) return 'ì´ˆë¡';
            if (b > r + 30 && b > g + 30) return 'íŒŒë‘';
            if (r > 150 && g > 150 && b < 100) return 'ë…¸ë‘';
            if (r > 100 && g < 100 && b > 150) return 'ë³´ë¼';
            if (r > 150 && g < 100 && b < 100) return 'ì£¼í™©';
            if (r < 100 && g > 150 && b > 150) return 'ì²­ë¡';
            
            return 'í˜¼í•©';
        }

        // Motion Detection
        function detectMotion(index, currentFrame, srcFrame) {
            if (!previousFrames[index]) {
                previousFrames[index] = currentFrame.clone();
                return;
            }

            try {
                // í”„ë ˆì„ ì°¨ì´ ê³„ì‚°
                const diff = new cv.Mat();
                cv.absdiff(previousFrames[index], currentFrame, diff);

                // ì´ì§„í™”
                const thresh = new cv.Mat();
                cv.threshold(diff, thresh, 30, 255, cv.THRESH_BINARY);

                // ëª¨í´ë¡œì§€ ì—°ì‚° (ë…¸ì´ì¦ˆ ì œê±°)
                const kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(5, 5));
                const cleaned = new cv.Mat();
                cv.morphologyEx(thresh, cleaned, cv.MORPH_OPEN, kernel);
                cv.morphologyEx(cleaned, cleaned, cv.MORPH_CLOSE, kernel);

                // ì›€ì§ì„ ì˜ì—­ ì°¾ê¸°
                const contours = new cv.MatVector();
                const hierarchy = new cv.Mat();
                cv.findContours(cleaned, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                let motionCount = 0;
                const objects = []; // ê°ì²´ ë°°ì—´
                const boundingBoxes = [];
                
                for (let i = 0; i < contours.size(); i++) {
                    const contour = contours.get(i);
                    const area = cv.contourArea(contour);
                    if (area > 500) { // ìµœì†Œ ì˜ì—­ í¬ê¸°
                        motionCount++;
                        
                        // ë°”ìš´ë”© ë°•ìŠ¤ ê³„ì‚°
                        const rect = cv.boundingRect(contour);
                        const centerX = rect.x + rect.width / 2;
                        const centerY = rect.y + rect.height / 2;
                        
                        // ê°ì²´ ìƒ‰ìƒ ê³„ì‚°
                        let color = { r: 0, g: 0, b: 0, name: 'ì•Œ ìˆ˜ ì—†ìŒ' };
                        if (srcFrame) {
                            color = calculateObjectColor(srcFrame, rect.x, rect.y, rect.width, rect.height);
                            color.name = getColorName(color.r, color.g, color.b);
                        }
                        
                        // ê°ì²´ ì†ì„± ë°°ì—´ì— ì¶”ê°€
                        const objectId = objects.length + 1;
                        const object = {
                            id: objectId,
                            type: 'unknown', // ê°ì²´ íƒ€ì… (ì°¨ëŸ‰, ì‚¬ëŒ, ê¸°íƒ€ ë“±)
                            position: {
                                x: rect.x,
                                y: rect.y,
                                centerX: centerX,
                                centerY: centerY
                            },
                            size: {
                                width: rect.width,
                                height: rect.height,
                                area: area
                            },
                            velocity: {
                                x: 0, // ì†ë„ (ì´ì „ ìœ„ì¹˜ì™€ ë¹„êµí•˜ì—¬ ê³„ì‚°)
                                y: 0,
                                speed: 0
                            },
                            color: color, // ìƒ‰ìƒ ì •ë³´ ì¶”ê°€
                            status: 'active', // active, stationary, lost
                            confidence: 0.8, // ê°ì§€ ì‹ ë¢°ë„
                            timestamp: Date.now(),
                            lastSeen: Date.now()
                        };

                        // ì´ì „ ê°ì²´ì™€ ë§¤ì¹­í•˜ì—¬ ì†ë„ ê³„ì‚°
                        if (analysisData[index] && analysisData[index].objects && analysisData[index].objects.length > 0) {
                            const prevObjects = analysisData[index].objects;
                            const matched = prevObjects.find(prev => {
                                const distance = Math.sqrt(
                                    Math.pow(prev.position.centerX - centerX, 2) + 
                                    Math.pow(prev.position.centerY - centerY, 2)
                                );
                                return distance < 100; // 100í”½ì…€ ì´ë‚´ë©´ ê°™ì€ ê°ì²´ë¡œ ê°„ì£¼
                            });
                            
                            if (matched) {
                                object.id = matched.id;
                                object.velocity = {
                                    x: centerX - matched.position.centerX,
                                    y: centerY - matched.position.centerY,
                                    speed: Math.sqrt(
                                        Math.pow(centerX - matched.position.centerX, 2) + 
                                        Math.pow(centerY - matched.position.centerY, 2)
                                    )
                                };
                                object.type = matched.type; // íƒ€ì… ìœ ì§€
                                // ìƒ‰ìƒì€ ìƒˆë¡œ ê³„ì‚° (ê°ì²´ê°€ ì›€ì§ì´ë©´ì„œ ìƒ‰ìƒì´ ë³€í•  ìˆ˜ ìˆìŒ)
                            }
                        }

                        objects.push(object);
                        boundingBoxes.push({
                            x: rect.x,
                            y: rect.y,
                            width: rect.width,
                            height: rect.height,
                            area: area,
                            objectId: object.id
                        });
                    }
                    contour.delete();
                }

                // ë°ì´í„° ì—…ë°ì´íŠ¸
                if (!analysisData[index]) {
                    analysisData[index] = { 
                        motionCount: 0, 
                        objects: [],
                        trackedObjects: [], 
                        boundingBoxes: [],
                        background: {}
                    };
                }
                analysisData[index].motionCount = motionCount;
                analysisData[index].objects = objects; // ê°ì²´ ë°°ì—´ ì €ì¥
                analysisData[index].boundingBoxes = boundingBoxes;
                analysisData[index].lastMotionUpdate = Date.now();

                // ì´ì „ í”„ë ˆì„ ì—…ë°ì´íŠ¸
                previousFrames[index].delete();
                previousFrames[index] = currentFrame.clone();

                // ë©”ëª¨ë¦¬ ì •ë¦¬
                diff.delete();
                thresh.delete();
                cleaned.delete();
                kernel.delete();
                contours.delete();
                hierarchy.delete();

            } catch (error) {
                console.error(`Motion Detection ì˜¤ë¥˜ (ì¹´ë©”ë¼ ${index}):`, error);
            }
        }

        // Object Tracking (KCF ì¶”ì ê¸°)
        function trackObjects(index, frame) {
            if (!analysisData[index]) {
                analysisData[index] = { motionCount: 0, trackedObjects: [] };
            }

            // ì›€ì§ì„ì´ ê°ì§€ë˜ë©´ ì¶”ì  ì‹œì‘
            if (analysisData[index].motionCount > 0) {
                if (!trackers[index]) {
                    trackers[index] = [];
                }

                // ê°„ë‹¨í•œ ê°ì²´ ì¶”ì  (ì‹¤ì œë¡œëŠ” KCF, CSRT ë“± ì‚¬ìš©)
                // ì—¬ê¸°ì„œëŠ” ì›€ì§ì„ ì˜ì—­ì„ ê°ì²´ë¡œ ê°„ì£¼
                const trackedCount = Math.min(analysisData[index].motionCount, 5);
                
                if (!analysisData[index].trackedObjects) {
                    analysisData[index].trackedObjects = [];
                }

                // ì¶”ì  ì¤‘ì¸ ê°ì²´ ì—…ë°ì´íŠ¸
                analysisData[index].trackedObjects = Array(trackedCount).fill(0).map((_, i) => ({
                    id: i + 1,
                    status: 'ì¶”ì  ì¤‘',
                    lastSeen: Date.now()
                }));

                analysisData[index].lastTrackingUpdate = Date.now();
            } else {
                // ì›€ì§ì„ì´ ì—†ìœ¼ë©´ ì¶”ì  ê°ì²´ ì´ˆê¸°í™”
                if (analysisData[index].trackedObjects) {
                    const timeSinceLastMotion = Date.now() - (analysisData[index].lastMotionUpdate || 0);
                    if (timeSinceLastMotion > 5000) { // 5ì´ˆ ì´ìƒ ì›€ì§ì„ ì—†ìœ¼ë©´
                        analysisData[index].trackedObjects = [];
                    }
                }
            }
        }

        // ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°
        function drawBoundingBoxes(index, video) {
            const overlayCanvas = document.getElementById(`overlay-${index}`);
            if (!overlayCanvas || !analysisData[index] || !analysisData[index].boundingBoxes) {
                return;
            }

            const videoElement = video;
            if (!videoElement || videoElement.readyState !== 4) {
                return;
            }

            // ë¹„ë””ì˜¤ í¬ê¸°ì™€ í‘œì‹œ í¬ê¸° ê³„ì‚°
            const videoWidth = videoElement.videoWidth || 640;
            const videoHeight = videoElement.videoHeight || 480;
            
            // ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ í¬ê¸°
            const container = overlayCanvas.parentElement.parentElement;
            const containerRect = container.getBoundingClientRect();
            const containerWidth = containerRect.width;
            const containerHeight = containerRect.height;

            // ë¹„ë””ì˜¤ê°€ ì»¨í…Œì´ë„ˆì— ë§ì¶° í‘œì‹œë˜ëŠ” ì‹¤ì œ í¬ê¸° ê³„ì‚°
            const videoAspect = videoWidth / videoHeight;
            const containerAspect = containerWidth / containerHeight;
            
            let displayWidth, displayHeight, offsetX, offsetY;
            
            if (videoAspect > containerAspect) {
                // ë¹„ë””ì˜¤ê°€ ë” ë„“ìŒ (ì¢Œìš° ì—¬ë°±)
                displayWidth = containerWidth;
                displayHeight = containerWidth / videoAspect;
                offsetX = 0;
                offsetY = (containerHeight - displayHeight) / 2;
            } else {
                // ë¹„ë””ì˜¤ê°€ ë” ë†’ìŒ (ìƒí•˜ ì—¬ë°±)
                displayWidth = containerHeight * videoAspect;
                displayHeight = containerHeight;
                offsetX = (containerWidth - displayWidth) / 2;
                offsetY = 0;
            }

            // Canvas í¬ê¸° ì„¤ì •
            overlayCanvas.width = containerWidth;
            overlayCanvas.height = containerHeight;
            
            const ctx = overlayCanvas.getContext('2d');
            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

            // ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°
            const boxes = analysisData[index].boundingBoxes;
            const scaleX = displayWidth / videoWidth;
            const scaleY = displayHeight / videoHeight;

            boxes.forEach((box, i) => {
                const x = offsetX + (box.x * scaleX);
                const y = offsetY + (box.y * scaleY);
                const width = box.width * scaleX;
                const height = box.height * scaleY;

                // ì‚¬ê°í˜• ê·¸ë¦¬ê¸°
                ctx.strokeStyle = '#00FF00'; // ì´ˆë¡ìƒ‰
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, width, height);

                // ê°ì²´ ID í‘œì‹œ
                ctx.fillStyle = '#00FF00';
                ctx.font = '12px Arial';
                ctx.fillText(`ê°ì²´ ${i + 1}`, x + 5, y - 5);
            });
        }

        // ë¶„ì„ ê²°ê³¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateAnalysisText(index) {
            const textElement = document.getElementById(`analysis-text-${index}`);
            if (!textElement || !analysisData[index]) return;

            const data = analysisData[index];
            let text = '';

            // ë°°ê²½ ì†ì„±
            if (data.background) {
                text += `ğŸŒ ë°°ê²½: ë°ê¸° ${data.background.averageBrightness}, ì•ˆì •ì„± ${data.background.stability}%\n`;
            }

            // Motion Detection ê²°ê³¼
            if (data.motionCount > 0) {
                text += `ğŸ”´ ì›€ì§ì„ ê°ì§€: ${data.motionCount}ê°œ ì˜ì—­\n`;
            } else {
                text += `ğŸŸ¢ ì›€ì§ì„ ì—†ìŒ\n`;
            }

            // ê°ì²´ ë°°ì—´ ì •ë³´
            if (data.objects && data.objects.length > 0) {
                text += `ğŸ‘ï¸ ê°ì²´ ë°°ì—´: ${data.objects.length}ê°œ\n`;
                data.objects.forEach((obj, i) => {
                    if (i < 3) { // ìµœëŒ€ 3ê°œë§Œ í‘œì‹œ
                        const speed = Math.round(obj.velocity.speed);
                        let colorInfo = '';
                        if (obj.color) {
                            const colorBox = `<span style="display: inline-block; width: 12px; height: 12px; background-color: rgb(${obj.color.r}, ${obj.color.g}, ${obj.color.b}); border: 1px solid #fff; vertical-align: middle; margin-right: 4px;"></span>`;
                            colorInfo = ` ${colorBox} ìƒ‰ìƒ: ${obj.color.name} (RGB: ${obj.color.r}, ${obj.color.g}, ${obj.color.b})`;
                        }
                        text += `   - ê°ì²´ #${obj.id}: ìœ„ì¹˜(${Math.round(obj.position.x)}, ${Math.round(obj.position.y)}), ì†ë„ ${speed}px/s${colorInfo}\n`;
                    }
                });
            } else {
                text += `ğŸ‘ï¸ ê°ì²´ ë°°ì—´: ì—†ìŒ\n`;
            }

            // ìƒíƒœ ìš”ì•½
            if (data.motionCount > 0) {
                text += `ğŸ“Š ìƒíƒœ: í™œë™ ì¤‘`;
            } else {
                text += `ğŸ“Š ìƒíƒœ: ì •ì§€`;
            }

            // ì‚¬ì´ë“œë°” ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸
            updateSidebarAnalysis(index);

            // HTML íƒœê·¸ê°€ í¬í•¨ëœ í…ìŠ¤íŠ¸ ì²˜ë¦¬
            const lines = text.split('\n');
            textElement.innerHTML = lines.map(line => {
                // ì´ë¯¸ HTML íƒœê·¸ê°€ í¬í•¨ëœ ê²½ìš° (ìƒ‰ìƒ ë°•ìŠ¤ ë“±)
                if (line.includes('<span')) {
                    if (line.includes('ì›€ì§ì„ ê°ì§€')) {
                        return `<span class="status-item motion-detected">${line}</span>`;
                    } else if (line.includes('ê°ì²´ ë°°ì—´') || line.includes('ê°ì²´ #')) {
                        return `<span class="status-item object-tracked">${line}</span>`;
                    }
                    return `<span class="status-item">${line}</span>`;
                }
                
                // ì¼ë°˜ í…ìŠ¤íŠ¸
                if (line.includes('ì›€ì§ì„ ê°ì§€')) {
                    return `<span class="status-item motion-detected">${line}</span>`;
                } else if (line.includes('ê°ì²´ ë°°ì—´') || line.includes('ê°ì²´ #')) {
                    return `<span class="status-item object-tracked">${line}</span>`;
                }
                return `<span class="status-item">${line}</span>`;
            }).join('<br>');
        }

        // ê°ì²´ ë°°ì—´ ê°€ì ¸ì˜¤ê¸° (ì™¸ë¶€ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
        function getObjectsArray(cameraIndex) {
            if (analysisData[cameraIndex] && analysisData[cameraIndex].objects) {
                return analysisData[cameraIndex].objects;
            }
            return [];
        }

        // ë°°ê²½ ì†ì„± ê°€ì ¸ì˜¤ê¸° (ì™¸ë¶€ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
        function getBackgroundProperties(cameraIndex) {
            if (analysisData[cameraIndex] && analysisData[cameraIndex].background) {
                return analysisData[cameraIndex].background;
            }
            return null;
        }

        // BIT MAX í‰ê· ê°’ ê³„ì‚° (ì§€ì •ëœ ì‹œê°„ ë²”ìœ„)
        function calculateBitAverage(index, seconds) {
            if (!bitMaxHistory[index] || bitMaxHistory[index].length === 0) {
                return null;
            }

            const now = Date.now();
            const cutoffTime = now - (seconds * 1000);
            
            const values = bitMaxHistory[index]
                .filter(item => item.timestamp >= cutoffTime)
                .map(item => item.value);

            if (values.length === 0) {
                return null;
            }

            const sum = values.reduce((acc, val) => acc + val, 0);
            return sum / values.length;
        }

        // ëª¨ë“  ì¹´ë©”ë¼ì˜ ê°ì²´ ë°°ì—´ ê°€ì ¸ì˜¤ê¸°
        function getAllObjectsArrays() {
            const result = {};
            cameras.forEach((camera, index) => {
                result[index] = {
                    cameraName: camera.name,
                    objects: getObjectsArray(index),
                    background: getBackgroundProperties(index)
                };
            });
            return result;
        }

        // ê°ì²´ì™€ ë°°ê²½ ì •ë³´ë¥¼ ë°°ì—´ ë¬¸ìì—´ë¡œ ë³€í™˜
        function convertToArrayString(index) {
            if (!analysisData[index]) {
                return '';
            }

            const data = analysisData[index];
            const arrayParts = [];

            // ê°ì²´ ì •ë³´ ë°°ì—´
            if (data.objects && data.objects.length > 0) {
                data.objects.forEach((obj, i) => {
                    const objArray = [
                        obj.id,
                        Math.round(obj.position.x),
                        Math.round(obj.position.y),
                        Math.round(obj.position.centerX),
                        Math.round(obj.position.centerY),
                        Math.round(obj.size.width),
                        Math.round(obj.size.height),
                        Math.round(obj.size.area),
                        Math.round(obj.velocity.x),
                        Math.round(obj.velocity.y),
                        Math.round(obj.velocity.speed),
                        obj.confidence
                    ];
                    arrayParts.push(`ê°ì²´${i + 1}: [${objArray.join(', ')}]`);
                });
            }

            // ë°°ê²½ ì •ë³´ ë°°ì—´
            if (data.background) {
                const bgArray = [
                    data.background.averageBrightness || 0,
                    data.background.contrast || 0,
                    data.background.stability || 0
                ];
                arrayParts.push(`ë°°ê²½: [${bgArray.join(', ')}]`);
            }

            // ì›€ì§ì„ ì¹´ìš´íŠ¸
            arrayParts.push(`ì›€ì§ì„: [${data.motionCount || 0}]`);

            return arrayParts.join(' | ');
        }

        // BIT ê³„ì‚° ë° í‘œì‹œ
        function updateBitCalculation(index) {
            if (typeof wordNbUnicodeFormat === 'undefined' || typeof BIT_MAX_NB === 'undefined' || typeof BIT_MIN_NB === 'undefined') {
                // bitCalculation.jsê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•ŠìŒ
                setTimeout(() => updateBitCalculation(index), 500);
                return;
            }

            try {
                const data = analysisData[index];
                if (!data) {
                    return;
                }

                // ê°ì²´ì™€ ë°°ê²½ ì •ë³´ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
                let textData = '';
                
                // ê°ì²´ ì •ë³´ ì¶”ê°€
                if (data.objects && data.objects.length > 0) {
                    data.objects.forEach((obj, i) => {
                        textData += `ê°ì²´${obj.id}_x${Math.round(obj.position.x)}_y${Math.round(obj.position.y)}_w${Math.round(obj.size.width)}_h${Math.round(obj.size.height)}_a${Math.round(obj.size.area)}_v${Math.round(obj.velocity.speed)}`;
                        if (i < data.objects.length - 1) textData += ' ';
                    });
                }

                // ë°°ê²½ ì •ë³´ ì¶”ê°€
                if (data.background) {
                    textData += ` ë°°ê²½_ë°ê¸°${data.background.averageBrightness || 0}_ëŒ€ë¹„${data.background.contrast || 0}_ì•ˆì •ì„±${data.background.stability || 0}`;
                }

                // ì›€ì§ì„ ì •ë³´ ì¶”ê°€
                textData += ` ì›€ì§ì„${data.motionCount || 0}`;

                // í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
                if (!textData.trim()) {
                    textData = `ì¹´ë©”ë¼${index + 1}_ëŒ€ê¸°ì¤‘`;
                }

                // ìœ ë‹ˆì½”ë“œ ë°°ì—´ë¡œ ë³€í™˜
                const unicodeArray = wordNbUnicodeFormat(textData);
                
                // BIT ê³„ì‚°
                const bitMax = BIT_MAX_NB(unicodeArray);
                const bitMin = BIT_MIN_NB(unicodeArray);

                // BIT MAX ê°’ ê¸°ë¡ (ì‹œê°„ë³„)
                const now = Date.now();
                if (!bitMaxHistory[index]) {
                    bitMaxHistory[index] = [];
                }
                bitMaxHistory[index].push({ value: bitMax, timestamp: now });
                
                // 60ì´ˆ ì´ì „ ë°ì´í„° ì œê±°
                bitMaxHistory[index] = bitMaxHistory[index].filter(
                    item => now - item.timestamp <= 60000
                );

                // í‰ê· ê°’ ê³„ì‚°
                const avg10 = calculateBitAverage(index, 10);
                const avg30 = calculateBitAverage(index, 30);
                const avg60 = calculateBitAverage(index, 60);

                // ê²°ê³¼ í‘œì‹œ
                const bitMaxElement = document.getElementById(`bit-max-${index}`);
                const bitMinElement = document.getElementById(`bit-min-${index}`);
                const bitArrayElement = document.getElementById(`bit-array-${index}`);
                const bitAvg10Element = document.getElementById(`bit-avg-10-${index}`);
                const bitAvg30Element = document.getElementById(`bit-avg-30-${index}`);
                const bitAvg60Element = document.getElementById(`bit-avg-60-${index}`);

                if (bitMaxElement) {
                    // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ ì¶”ê°€
                    bitMaxElement.classList.add('updating');
                    bitMaxElement.textContent = bitMax.toFixed(15);
                    setTimeout(() => {
                        bitMaxElement.classList.remove('updating');
                    }, 500);
                }
                if (bitMinElement) {
                    // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ ì¶”ê°€
                    bitMinElement.classList.add('updating');
                    bitMinElement.textContent = bitMin.toFixed(15);
                    setTimeout(() => {
                        bitMinElement.classList.remove('updating');
                    }, 500);
                }
                if (bitAvg10Element) {
                    bitAvg10Element.textContent = avg10 !== null ? avg10.toFixed(15) : '-';
                }
                if (bitAvg30Element) {
                    bitAvg30Element.textContent = avg30 !== null ? avg30.toFixed(15) : '-';
                }
                if (bitAvg60Element) {
                    bitAvg60Element.textContent = avg60 !== null ? avg60.toFixed(15) : '-';
                }
                if (bitArrayElement) {
                    const arrayString = convertToArrayString(index);
                    bitArrayElement.textContent = arrayString || 'ë°ì´í„° ì—†ìŒ';
                }

                // ì‚¬ì´ë“œë°” ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸
                updateSidebarAnalysis(index);

            } catch (error) {
                console.error(`BIT ê³„ì‚° ì˜¤ë¥˜ (ì¹´ë©”ë¼ ${index}):`, error);
                const bitMaxElement = document.getElementById(`bit-max-${index}`);
                const bitMinElement = document.getElementById(`bit-min-${index}`);
                if (bitMaxElement) bitMaxElement.textContent = 'ì˜¤ë¥˜';
                if (bitMinElement) bitMinElement.textContent = 'ì˜¤ë¥˜';
            }
        }

        // ì‚¬ì´ë“œë°” ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸
        function updateSidebarAnalysis(index) {
            const sidebarContainer = document.getElementById('sidebarAnalysis');
            if (!sidebarContainer) return;

            const camera = cameras[index];
            if (!camera) return;

            const data = analysisData[index] || {};
            const bitMaxElement = document.getElementById(`bit-max-${index}`);
            const bitMinElement = document.getElementById(`bit-min-${index}`);
            const bitAvg10Element = document.getElementById(`bit-avg-10-${index}`);
            const bitAvg30Element = document.getElementById(`bit-avg-30-${index}`);
            const bitAvg60Element = document.getElementById(`bit-avg-60-${index}`);
            
            let bitMax = 'ê³„ì‚° ì¤‘...';
            let bitMin = 'ê³„ì‚° ì¤‘...';
            let bitAvg10 = '-';
            let bitAvg30 = '-';
            let bitAvg60 = '-';
            
            if (bitMaxElement && bitMaxElement.textContent !== 'ê³„ì‚° ì¤‘...' && bitMaxElement.textContent !== 'ì˜¤ë¥˜') {
                bitMax = bitMaxElement.textContent;
            }
            if (bitMinElement && bitMinElement.textContent !== 'ê³„ì‚° ì¤‘...' && bitMinElement.textContent !== 'ì˜¤ë¥˜') {
                bitMin = bitMinElement.textContent;
            }
            if (bitAvg10Element && bitAvg10Element.textContent !== '-' && bitAvg10Element.textContent !== 'ê³„ì‚° ì¤‘...') {
                bitAvg10 = bitAvg10Element.textContent;
            }
            if (bitAvg30Element && bitAvg30Element.textContent !== '-' && bitAvg30Element.textContent !== 'ê³„ì‚° ì¤‘...') {
                bitAvg30 = bitAvg30Element.textContent;
            }
            if (bitAvg60Element && bitAvg60Element.textContent !== '-' && bitAvg60Element.textContent !== 'ê³„ì‚° ì¤‘...') {
                bitAvg60 = bitAvg60Element.textContent;
            }

            // ëª¨ë“  ì¹´ë©”ë¼ì˜ BIT MAX ê°’ì„ ìˆ˜ì§‘í•˜ì—¬ ìˆœìœ„ ê³„ì‚°
            const bitMaxValues = cameras.map((camera, idx) => {
                const bitMaxEl = document.getElementById(`bit-max-${idx}`);
                let bitMaxVal = 'ê³„ì‚° ì¤‘...';
                if (bitMaxEl && bitMaxEl.textContent !== 'ê³„ì‚° ì¤‘...' && bitMaxEl.textContent !== 'ì˜¤ë¥˜') {
                    bitMaxVal = bitMaxEl.textContent;
                }
                return { index: idx, value: bitMaxVal, numValue: parseFloat(bitMaxVal) || 0 };
            });

            // BIT MAX ê°’ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ìˆœìœ„ ê³„ì‚°
            const sorted = [...bitMaxValues].sort((a, b) => b.numValue - a.numValue);
            const rankMap = new Map();
            sorted.forEach((item, rank) => {
                rankMap.set(item.index, rank + 1);
            });

            // ìˆœìœ„ë³„ ìƒ‰ìƒ ê³„ì‚°
            const rank = rankMap.get(index) || cameras.length;
            const bitMaxColor = getBitRankColor(bitMax, rank, cameras.length);

            const motionCount = data.motionCount || 0;
            const objectCount = (data.objects && data.objects.length) || 0;
            const background = data.background || {};
            const brightness = background.averageBrightness || 0;
            const stability = background.stability || 0;

            // í•´ë‹¹ ì¹´ë©”ë¼ì˜ ì‚¬ì´ë“œë°” ì•„ì´í…œ ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
            const sidebarItems = sidebarContainer.querySelectorAll('.sidebar-analysis-item');
            if (sidebarItems[index]) {
                const item = sidebarItems[index];
                const content = item.querySelector('.sidebar-analysis-item-content');
                if (content) {
                    content.innerHTML = `
                        <div class="info-row">
                            <span class="info-label">BIT MAX:</span>
                            <span class="info-value bit-value" style="color: ${bitMaxColor};">${bitMax}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">BIT MIN:</span>
                            <span class="info-value bit-value">${bitMin}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">í‰ê·  (10ì´ˆ):</span>
                            <span class="info-value bit-value">${bitAvg10}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">í‰ê·  (30ì´ˆ):</span>
                            <span class="info-value bit-value">${bitAvg30}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">í‰ê·  (60ì´ˆ):</span>
                            <span class="info-value bit-value">${bitAvg60}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ì›€ì§ì„:</span>
                            <span class="info-value">${motionCount}ê°œ</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ê°ì²´:</span>
                            <span class="info-value">${objectCount}ê°œ</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ë°ê¸°:</span>
                            <span class="info-value">${brightness}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ì•ˆì •ì„±:</span>
                            <span class="info-value">${stability}%</span>
                        </div>
                    `;
                }
            }
        }

        // ì´ˆê¸°í™”
        loadCameras();
        loadTimerSettings(); // íƒ€ì´ë¨¸ ì„¤ì • ë¡œë“œ
        
        // OpenCV.js ë¡œë“œ í™•ì¸
        checkOpenCV();
  </script>
</body>
</html>
